# evolveTrial

**evolveTrial** provides utilities for designing and simulating Bayesian
adaptive platform and umbrella clinical trials with time-to-event
endpoints. The package supports the ARPA-H ADAPT breast cancer platform
trial design.

## Key Features

- **Multi-arm adaptive trials**: Simulate trials comparing experimental
  arms to a reference arm with proportional hazards
- **Single-arm vs historical control**: Evaluate efficacy relative to
  historical benchmarks
- **Bayesian decision rules**: Interim stopping for efficacy or futility
  based on posterior probabilities
- **Piecewise exponential hazards**: Flexible time-to-event modeling
  with interval-specific hazards
- **Information gates**: Control interim timing via minimum events,
  median follow-up, and person-time requirements
- **Operating characteristics**: Type I error, power, expected sample
  size, and probability of early termination
- **C++ acceleration**: Posterior sampling and hazard computations via
  Rcpp for high performance

## Installation

### Prerequisites for Compiling C++ Code

This package contains C++ code (via Rcpp) that must be compiled during
installation. **Most users will need to install additional tools before
installing evolveTrial.**

#### Windows Users

You must install **Rtools** before installing packages with C++ code: 1.
Download Rtools from: <https://cran.r-project.org/bin/windows/Rtools/>
2. Choose the version matching your R version (e.g., Rtools44 for R
4.4.x) 3. Run the installer with default settings 4. Restart R/RStudio
after installation

To verify Rtools is installed correctly:

``` r
Sys.which("make")
# Should return a path like "C:/rtools44/usr/bin/make.exe"
```

#### macOS Users

You must install **Xcode Command Line Tools**:

``` bash
# Run this in Terminal (not R)
xcode-select --install
```

A dialog will appear - click “Install” and wait for completion (~5-10
minutes).

For **Apple Silicon Macs (M1/M2/M3)**, you may also need gfortran:

``` bash
# Install Homebrew if not already installed
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Install gfortran
brew install gcc
```

To verify your toolchain is ready:

``` r
# In R, check for C++ compiler
system("clang++ --version")
```

#### Linux Users

Most Linux distributions include the necessary compilers. If not:

``` bash
# Ubuntu/Debian
sudo apt-get install r-base-dev

# Fedora/RHEL
sudo dnf install R-devel
```

### From GitHub (Recommended)

Install the development version from GitHub using one of these methods:

``` r
# Using pak (fastest, handles compilation automatically)
install.packages("pak")
pak::pak("naimurashid/evolveTrial")

# Or using remotes
install.packages("remotes")
remotes::install_github("naimurashid/evolveTrial")

# Or using devtools
install.packages("devtools")
devtools::install_github("naimurashid/evolveTrial")
```

### Dependencies

The package requires:

- **Core**: `data.table`, `ggplot2`, `magrittr`, `progress`,
  `tidyselect`
- **Suggested**: `dplyr`, `gt`, `openxlsx`, `ggrepel`, `knitr`,
  `rmarkdown`

All dependencies will be installed automatically when you install
evolveTrial.

### Development Installation

For development work with the latest features:

``` r
# Clone the repository
git clone https://github.com/naimurashid/evolveTrial.git

# Load in R session
devtools::load_all("path/to/evolveTrial")
```

### Troubleshooting Installation

**“Error: compilation failed”** or **“make: not found”** - Windows:
Rtools is not installed or not on PATH. Reinstall Rtools and restart
R. - macOS: Xcode Command Line Tools not installed. Run
`xcode-select --install` in Terminal.

**“fatal error: ‘RcppArmadillo.h’ file not found”**

``` r
# Install RcppArmadillo first
install.packages("RcppArmadillo")
# Then retry evolveTrial installation
```

**“ld: library not found for -lgfortran”** (macOS)

``` bash
# Install gfortran via Homebrew
brew install gcc
```

**Installation hangs or times out**

``` r
# Try installing without vignettes (faster)
remotes::install_github("naimurashid/evolveTrial", build_vignettes = FALSE)
```

**Still having issues?** - Check that your R version is 4.0 or higher:
`R.version.string` - Open an issue at:
<https://github.com/naimurashid/evolveTrial/issues>

## Diagnosing interim gating choices

When early stopping does not seem to occur during simulations, it is
often because the information gates (minimum events, median follow-up,
or required person-time) postpone the first informative interim look
until late in the trial. The helper
[`estimate_vsref_gate_timing()`](reference/estimate_vsref_gate_timing.md)
gives quick lower-bound heuristics for when those gates can all be
satisfied under deterministic accrual.

``` r
library(evolveTrial)

args <- list(
  arm_names = c("Doublet", "Triplet"),
  reference_arm_name = "Doublet",
  overall_accrual_rate = 3,
  randomization_probs = c(Doublet = 0.5, Triplet = 0.5),
  max_total_patients_per_arm = c(Doublet = 70, Triplet = 70),
  max_follow_up_sim = 24,
  min_events_per_arm = 8,
  min_median_followup_per_arm = 3,
  min_person_time_frac_per_arm = 0.15
)

estimate_vsref_gate_timing(args)
```

For the configuration above the joint lower bound is roughly 18 months,
meaning that with 3-month calendar beats the first eligible interim look
will occur near the sixth look. Adjusting the information gates (for
example by lowering the person-time fraction or the minimum median
follow-up) yields earlier opportunities for efficacy/futility stopping.

## Minimal Working Examples

### Example 1: Multi-arm Trial (Experimental vs Reference)

Simulate a two-arm trial comparing Triplet therapy against Doublet
(reference) with interim efficacy and futility stopping:

``` r
library(evolveTrial)

# Define trial arguments
args <- list(
  # Arm configuration
  arm_names = c("Doublet", "Triplet"),
  reference_arm_name = "Doublet",
  randomization_probs = c(Doublet = 0.5, Triplet = 0.5),
  overall_accrual_rate = 3,

  # Sample size limits
  max_total_patients_per_arm = c(Doublet = 70, Triplet = 70),
  max_follow_up_sim = 24,

  # Piecewise hazards (8 3-month intervals)
  pw_hazards = list(
    Doublet = rep(0.12, 8),  # Median ~6 months
    Triplet = rep(0.077, 8)  # Median ~9 months (HR = 0.67)
  ),
  interval_width = 3,

  # Bayesian decision thresholds
  efficacy_prob_threshold_vsref = 0.99,
  futility_prob_threshold_vsref = 0.10,

  # Information gates
  min_events_per_arm = 8,
  min_median_followup_per_arm = 3,
  min_person_time_frac_per_arm = 0.15,

  # Interim schedule
  beat_interval = 3,

  # MCMC settings
  n_posterior_draws = 5000
)

# Run Monte Carlo simulation (100 replicates for demo)
result <- run_single_scenario(args, n_sim = 100, seed = 2025)

# View key operating characteristics
summary(result)
#> Power: ~80%, Type I error: ~10%, Expected N: ~85 per arm
```

### Example 2: Single-arm vs Historical Control

Evaluate a single experimental arm against a historical median survival:

``` r
library(evolveTrial)

# Define trial arguments for single-arm design
args_sa <- list(
  # Arm configuration (vs historical control)
  arm_names = c("Control", "Experimental"),
  reference_arm_name = "Control",
  use_historical_control = TRUE,
  randomization_probs = c(Control = 0, Experimental = 1),
  overall_accrual_rate = 2,

  # Sample size
  max_total_patients_per_arm = c(Control = 0, Experimental = 60),
  max_follow_up_sim = 24,

  # Hazards: Historical median 6 months, experimental median 9 months
  pw_hazards = list(
    Control = rep(0.116, 8),      # Historical: median 6 mo
    Experimental = rep(0.077, 8)  # Expected: median 9 mo
  ),
  interval_width = 3,

  # Decision thresholds vs historical
  efficacy_prob_threshold_hc = 0.95,
  futility_prob_threshold_hc = 0.05,

  # Information gates
  min_events_hc = 15,

  # Interim schedule
  beat_interval = 3,
  n_posterior_draws = 5000
)

# Run simulation
result_sa <- run_single_scenario(args_sa, n_sim = 100, seed = 2025)

# View operating characteristics
summary(result_sa)
```

### Example 3: Grid Search for Optimal Thresholds

Find efficacy/futility thresholds that meet operating characteristic
targets:

``` r
library(evolveTrial)

# Base trial configuration
args <- list(
  arm_names = c("Control", "Experimental"),
  reference_arm_name = "Control",
  use_historical_control = TRUE,
  randomization_probs = c(Control = 0, Experimental = 1),
  overall_accrual_rate = 2,
  max_total_patients_per_arm = c(Control = 0, Experimental = 60),
  max_follow_up_sim = 24,
  pw_hazards = list(
    Control = rep(0.116, 8),
    Experimental = rep(0.077, 8)
  ),
  interval_width = 3,
  min_events_hc = 15,
  beat_interval = 3,
  n_posterior_draws = 5000
)

# Define threshold grid
grid <- expand.grid(
  efficacy_prob_threshold_hc = c(0.90, 0.95, 0.99),
  futility_prob_threshold_hc = c(0.05, 0.10, 0.15)
)

# Evaluate grid (use evaluate_hc_grid for historical control)
results <- evaluate_hc_grid(
  base_args = args,
  grid = grid,
  n_sim = 500,
  parallel = TRUE,
  seed = 2025
)

# Filter feasible designs (type I <= 0.10, power >= 0.80)
feasible <- filter_feasible_designs(
  results,
  alpha_cap = 0.10,
  power_floor = 0.80
)

# Recommend optimal design (minimizes expected N)
best <- recommend_design(feasible)
print(best)
```

## Key Functions

| Function                                                                  | Purpose                                          |
|---------------------------------------------------------------------------|--------------------------------------------------|
| `run_single_scenario()`                                                   | Simulate a single trial configuration            |
| [`run_scenarios()`](reference/run_scenarios.md)                           | Simulate multiple scenario configurations        |
| `evaluate_hc_grid()`                                                      | Grid search for single-arm vs historical control |
| [`evaluate_ph_grid()`](reference/evaluate_ph_grid.md)                     | Grid search for multi-arm proportional hazards   |
| `filter_feasible_designs()`                                               | Filter designs meeting alpha/power constraints   |
| `recommend_design()`                                                      | Select optimal design from feasible set          |
| [`estimate_vsref_gate_timing()`](reference/estimate_vsref_gate_timing.md) | Diagnose information gate timing                 |
| `summarise_arm_level_OCs()`                                               | Summarize operating characteristics              |

## Package Structure

    evolveTrial/
    ├── R/
    │   ├── simulation_driver.R      # Main simulation functions
    │   ├── design_analysis.R        # Grid search and optimization
    │   ├── gate_diagnostics.R       # Information gate utilities
    │   ├── interim_logic.R          # Stopping rule implementation
    │   ├── posterior_helpers.R      # Bayesian posterior computations
    │   └── data_generation.R        # Time-to-event data generation
    ├── src/
    │   └── *.cpp                    # C++ acceleration code
    └── vignettes/
        └── design-overview.Rmd      # Detailed methodology

## Related Packages

- **evolveBO**: Bayesian optimization for calibrating evolveTrial
  designs
- **adaptive-trial-bo-paper**: Research manuscript and case studies

# Package index

## All functions

- [`CONVERSION_TRIGGERS`](CONVERSION_TRIGGERS.md) : Conversion triggers
- [`FUTILITY_ACTIONS`](FUTILITY_ACTIONS.md) : Futility actions
- [`HYBRID_STATES`](HYBRID_STATES.md) : hybrid_trial.R Core hybrid
  single-arm to between-arm Bayesian adaptive trial simulator
- [`adopt_calibration()`](adopt_calibration.md) : Adopt a calibrated
  design configuration
- [`apply_futility_action()`](apply_futility_action.md) : Apply futility
  action to trial state
- [`apply_recommended_to_args()`](apply_recommended_to_args.md) : Apply
  a recommended early-stopping configuration to the argument list
- [`calculate_median_survival_matrix_cpp()`](calculate_median_survival_matrix_cpp.md)
  : Calculate median survival for multiple hazard samples (C++
  implementation)
- [`calculate_median_survival_piecewise_cpp()`](calculate_median_survival_piecewise_cpp.md)
  : Calculate median survival for piecewise exponential model (C++
  implementation)
- [`calibrate_alpha()`](calibrate_alpha.md) : Calibrate interim and
  final thresholds for single-arm designs
- [`check_conversion_trigger()`](check_conversion_trigger.md) : Check if
  conversion trigger is met
- [`classify_trial_outcome()`](classify_trial_outcome.md) : Classify
  final trial outcome
- [`compare_sa_vs_hybrid()`](compare_sa_vs_hybrid.md) : Compare SA-only
  vs Hybrid decision
- [`compare_simon_to_bo()`](compare_simon_to_bo.md) : Validate BO
  calibration against Simon enumeration
- [`compile_hybrid_results()`](compile_hybrid_results.md) : Compile
  hybrid trial results
- [`compute_ba_posterior()`](compute_ba_posterior.md) : Compute
  between-arm posterior probability
- [`compute_ba_posterior_exponential()`](compute_ba_posterior_exponential.md)
  : Compute exact PP for exponential model (for validation)
- [`compute_ba_posterior_pwe_mc()`](compute_ba_posterior_pwe_mc.md) :
  Monte Carlo comparison for PWE posteriors
- [`compute_interval_metrics()`](compute_interval_metrics.md) : Compute
  interval-specific metrics from registry
- [`compute_p_between_arm()`](compute_p_between_arm.md) : Compute
  between-arm posterior probability
- [`compute_p_single_arm()`](compute_p_single_arm.md) : Compute
  single-arm posterior probability
- [`compute_pp_curve()`](compute_pp_curve.md) : Compute predictive
  probability curve
- [`compute_pp_curve_posterior()`](compute_pp_curve_posterior.md) :
  Compute PP curve using posterior method
- [`compute_pp_curve_predictive()`](compute_pp_curve_predictive.md) :
  Compute PP curve using predictive probability method
- [`compute_pp_posterior()`](compute_pp_posterior.md) : Compute PP using
  posterior method (fast approximation)
- [`compute_pp_posterior_single()`](compute_pp_posterior_single.md) :
  Compute posterior-based PP for single N_add
- [`compute_pp_predictive()`](compute_pp_predictive.md) : Compute PP
  using predictive method (Monte Carlo)
- [`compute_pp_predictive_full()`](compute_pp_predictive_full.md) :
  Compute predictive probability for a single N_add value
- [`compute_pp_predictive_pwe()`](compute_pp_predictive_pwe.md) :
  Compute predictive probability with full PWE model
- [`compute_pwe_median()`](compute_pwe_median.md) : Compute median
  survival from PWE hazards
- [`compute_pwe_median_survival()`](compute_pwe_median_survival.md) :
  Compute median survival from PWE hazards
- [`compute_trial_oc()`](compute_trial_oc.md) : Compute operating
  characteristics for a single trial
- [`count_arm_events()`](count_arm_events.md) : Count events for an arm
  up to analysis time
- [`create_decision_report()`](create_decision_report.md) : Create
  structured decision report
- [`create_hybrid_state()`](create_hybrid_state.md) : Create initial
  hybrid trial state
- [`create_hybrid_theta()`](create_hybrid_theta.md) : Create hybrid
  design parameter structure
- [`create_simulation_cluster()`](create_simulation_cluster.md) : Create
  a reusable evolveTrial simulation cluster
- [`draw_posterior_hazard_samples_cpp()`](draw_posterior_hazard_samples_cpp.md)
  : Draw posterior hazard samples (C++ implementation)
- [`draw_posterior_response_rate()`](draw_posterior_response_rate.md) :
  Draw posterior samples for binary response rate
- [`estimate_vsref_gate_timing()`](estimate_vsref_gate_timing.md) :
  Estimate when the vs-reference interim gates can be satisfied
- [`evaluate_ba_efficacy()`](evaluate_ba_efficacy.md) : Evaluate
  between-arm efficacy
- [`evaluate_ba_futility()`](evaluate_ba_futility.md) : Evaluate
  between-arm futility
- [`evaluate_conversion_trigger()`](evaluate_conversion_trigger.md) :
  Evaluate conversion trigger
- [`evaluate_ph_grid()`](evaluate_ph_grid.md) : Evaluate PH-based grid
  of designs
- [`evaluate_sa_efficacy()`](evaluate_sa_efficacy.md) :
  hybrid_decisions.R Decision rules for hybrid single-arm to between-arm
  trials
- [`evaluate_sa_futility()`](evaluate_sa_futility.md) : Evaluate
  single-arm futility for an arm
- [`exp_arms_from_args()`](exp_arms_from_args.md) : Extract experimental
  arm names from an argument list
- [`expected_information_gain()`](expected_information_gain.md) :
  Expected information gain from additional patients
- [`explore_early_stopping_from_cal()`](explore_early_stopping_from_cal.md)
  : Explore early stopping knobs around a calibrated design
- [`export_scenario_table_to_excel()`](export_scenario_table_to_excel.md)
  : Export a scenario summary table to Excel
- [`export_scenario_table_to_png()`](export_scenario_table_to_png.md) :
  Render the scenario summary table to a PNG image
- [`filter_early_grid()`](filter_early_grid.md) : Filter early-stopping
  designs by operating targets
- [`find_optimal_n_add()`](find_optimal_n_add.md) : Optimal N_add finder
- [`find_simon_design()`](find_simon_design.md) : Find optimal Simon
  design
- [`generate_decision_summary()`](generate_decision_summary.md) :
  Generate human-readable decision summary
- [`get_historical_hazard()`](get_historical_hazard.md) : Get historical
  hazard for an arm
- [`grid_calibrate()`](grid_calibrate.md) : Calibrate historical-control
  thresholds over a grid
- [`handle_sa_futility()`](handle_sa_futility.md) : Handle single-arm
  futility for an arm
- [`handle_state_between()`](handle_state_between.md) : Handle
  STATE_BETWEEN phase
- [`handle_state_consider_conversion()`](handle_state_consider_conversion.md)
  : Handle STATE_CONSIDER_CONVERSION phase
- [`handle_state_single()`](handle_state_single.md) : Handle
  STATE_SINGLE phase
- [`is_trial_success()`](is_trial_success.md) : Determine if trial
  concluded with overall success
- [`make_conversion_decision()`](make_conversion_decision.md) : Make
  conversion decision based on PP curve
- [`perform_ssr()`](perform_ssr.md) : hybrid_ssr.R Sample Size
  Re-Estimation methods for hybrid trials
- [`ph_beta_mode_var()`](ph_beta_mode_var.md) : Compute mode and
  variance of log-HR posterior for PH model (DISPATCHER)
- [`ph_beta_mode_var_cpp()`](ph_beta_mode_var_cpp.md) : Compute mode and
  variance of log-HR posterior for PH model (C++ implementation)
- [`plot_calibration()`](plot_calibration.md) : Plot power versus type I
  error for calibration grids
- [`plot_early_tradeoff()`](plot_early_tradeoff.md) : Plot
  early-stopping trade-offs
- [`pretty_scenario_matrix()`](pretty_scenario_matrix.md) : Summarise
  simulation output by scenario and arm
- [`prob_response_below()`](prob_response_below.md) : Calculate
  posterior probability that response rate is below threshold
- [`prob_response_exceeds()`](prob_response_exceeds.md) : Calculate
  posterior probability that response rate exceeds threshold
- [`recommend_design_from_early()`](recommend_design_from_early.md) :
  Recommend a single early-stopping design
- [`release_cluster()`](release_cluster.md) : Release an evolveTrial
  simulation cluster
- [`run_scenarios()`](run_scenarios.md) : Evaluate a design across
  multiple scenarios
- [`run_simulation_binary()`](run_simulation_binary.md) : Run binary
  endpoint trial simulation
- [`run_simulation_pure()`](run_simulation_pure.md) : Run a full set of
  evolveTrial simulations for a design specification
- [`sample_vs_ref_medians_independent()`](sample_vs_ref_medians_independent.md)
  : Sample medians for vs-ref independent model (DISPATCHER)
- [`sample_vs_ref_medians_independent_cpp()`](sample_vs_ref_medians_independent_cpp.md)
  : Sample medians for vs-ref independent model (C++ implementation)
- [`sample_vs_ref_medians_ph()`](sample_vs_ref_medians_ph.md) : Sample
  medians for vs-ref PH model (DISPATCHER)
- [`sample_vs_ref_medians_ph_cpp()`](sample_vs_ref_medians_ph_cpp.md) :
  Sample medians for vs-ref PH model (C++ implementation)
- [`scenarios_from_grid()`](scenarios_from_grid.md) : Build scenario
  overrides from a grid of design choices
- [`select_arms_for_ba()`](select_arms_for_ba.md) : Select arms for
  between-arm comparison
- [`set_futility_medians()`](set_futility_medians.md) : Adjust futility
  medians for experimental arms
- [`simon_oc_exact()`](simon_oc_exact.md) : Calculate Simon design
  operating characteristics analytically
- [`simulate_future_arm_data()`](simulate_future_arm_data.md) : Simulate
  future arm data under PWE model
- [`simulate_future_arm_pwe()`](simulate_future_arm_pwe.md) : Simulate
  future arm data under PWE model
- [`simulate_pwe_survival()`](simulate_pwe_survival.md) : Simulate
  survival time from PWE model
- [`simulate_pwe_time()`](simulate_pwe_time.md) : Simulate survival time
  from PWE model
- [`test_armadillo_random()`](test_armadillo_random.md) : Test Armadillo
  matrix operations
- [`test_rcpp_sum()`](test_rcpp_sum.md) : Test Rcpp setup
- [`update_hybrid_state()`](update_hybrid_state.md) : Update hybrid
  trial state based on current conditions
- [`update_posteriors()`](update_posteriors.md) : Update posterior
  parameters from trial data
- [`validate_exponential_ba()`](validate_exponential_ba.md) : Validate
  MC against closed-form for exponential

# Articles

### All vignettes

- [design-overview](design-overview.md):
