<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md • evolveTrial</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">evolveTrial</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/design-overview.html">design-overview</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>CLAUDE.md</h1>

    </div>

<div id="claudemd" class="section level1">

<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a></h2>
<p><strong>evolveTrial</strong> is an R package for Bayesian adaptive platform/umbrella clinical trial simulation and design analysis. It specializes in progression-free survival (PFS) endpoints using piecewise exponential models with both single-arm (vs historical control) and multi-arm (vs-reference) decision logic.</p>
</div>
<div class="section level2">
<h2 id="package-structure">Package Structure<a class="anchor" aria-label="anchor" href="#package-structure"></a></h2>
<div class="section level3">
<h3 id="core-simulation-architecture">Core Simulation Architecture<a class="anchor" aria-label="anchor" href="#core-simulation-architecture"></a></h3>
<p>The simulation engine is built around three main components:</p>
<ol style="list-style-type: decimal"><li><p><strong>State Management</strong> (<code>R/state_management.R</code>): The <code>make_state()</code> function creates trial state containers tracking arm status (recruiting/stopped), patient registries, and enrollment counts. The <code>slice_arm_data_at_time()</code> function provides time-based snapshots of patient data for interim analyses, computing interval metrics via <code><a href="reference/calculate_interval_metrics_fast.html">calculate_interval_metrics_fast()</a></code>.</p></li>
<li>
<p><strong>Interim Logic</strong> (<code>R/interim_logic.R</code>): The <code>interim_check()</code> function is the decision engine that evaluates efficacy and futility at scheduled looks. It branches on <code>compare_arms_option</code>:</p>
<ul><li>
<strong>vs-reference path</strong>: Compares experimental arms against a reference/control arm using <code>calculate_current_probs_vs_ref()</code>, evaluating per-arm gates (<code>min_events_per_arm</code>, <code>min_median_followup_per_arm</code>, <code>min_person_time_frac_per_arm</code>)</li>
<li>
<strong>single-arm path</strong>: Evaluates arms independently against historical control targets using <code>calculate_current_probs_hc()</code>, with optional predictive probability fallbacks from <code>R/predictive_probabilities.R</code>
</li>
</ul></li>
<li><p><strong>Simulation Driver</strong> (<code>R/simulation_driver.R</code>): The <code><a href="reference/run_simulation_pure.html">run_simulation_pure()</a></code> function is the workhorse that orchestrates Monte Carlo replicates, enrolling patients via piecewise exponential data generation (<code>R/data_generation.R</code>), applying interim checks at calendar beats or person-time milestones, and accumulating operating characteristics (type I error, power, PET, expected N).</p></li>
</ol></div>
<div class="section level3">
<h3 id="statistical-helpers">Statistical Helpers<a class="anchor" aria-label="anchor" href="#statistical-helpers"></a></h3>
<ul><li>
<strong>Posterior Sampling</strong> (<code>R/posterior_helpers.R</code>): <code><a href="reference/draw_posterior_hazard_samples.html">draw_posterior_hazard_samples()</a></code> draws from Gamma posteriors for interval hazards; <code><a href="reference/calculate_median_survival_piecewise.html">calculate_median_survival_piecewise()</a></code> converts hazard vectors to median survival times (handles open-ended tail extrapolation)</li>
<li>
<strong>Predictive Probabilities</strong> (<code>R/predictive_probabilities.R</code>): <code>calculate_predicted_success_prob_vs_hc()</code> performs forward simulation from current posterior to final analysis</li>
<li>
<strong>PH Models</strong>: When <code>use_ph_model_vs_ref = TRUE</code>, vs-reference comparisons use a joint proportional-hazards model with log hazard ratio priors</li>
</ul></div>
<div class="section level3">
<h3 id="design-analysis-workflow">Design Analysis Workflow<a class="anchor" aria-label="anchor" href="#design-analysis-workflow"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Parameter Grid Setup</strong>: Define design grids (efficacy/futility thresholds, gates, sample sizes)</li>
<li>
<strong>Simulation</strong>: <code><a href="reference/run_scenarios.html">run_scenarios()</a></code> wraps <code><a href="reference/run_simulation_pure.html">run_simulation_pure()</a></code> for batch execution across scenarios (see <code>R/design_analysis.R</code>)</li>
<li>
<strong>Calibration</strong>: <code><a href="reference/grid_calibrate.html">grid_calibrate()</a></code> searches efficacy/futility threshold combinations to meet target type I error constraints; <code><a href="reference/calibrate_alpha.html">calibrate_alpha()</a></code> performs single-dimension searches</li>
<li>
<strong>Reporting</strong>: <code><a href="reference/pretty_scenario_matrix.html">pretty_scenario_matrix()</a></code> pivots results to scenario × arm tables; <code><a href="reference/export_scenario_table_to_excel.html">export_scenario_table_to_excel()</a></code> and <code><a href="reference/export_scenario_table_to_png.html">export_scenario_table_to_png()</a></code> generate formatted outputs</li>
</ol></div>
<div class="section level3">
<h3 id="gate-diagnostics">Gate Diagnostics<a class="anchor" aria-label="anchor" href="#gate-diagnostics"></a></h3>
<p>When early stopping fails to occur, it often means information gates postpone the first informative look. Use <code><a href="reference/estimate_vsref_gate_timing.html">estimate_vsref_gate_timing()</a></code> (from <code>R/gate_diagnostics.R</code>) to get lower-bound heuristics for when vs-reference gates (<code>min_events_per_arm</code>, <code>min_median_followup_per_arm</code>, <code>min_person_time_frac_per_arm</code>) can all be satisfied under deterministic accrual. See README.Rmd for examples.</p>
</div>
</div>
<div class="section level2">
<h2 id="development-commands">Development Commands<a class="anchor" aria-label="anchor" href="#development-commands"></a></h2>
<div class="section level3">
<h3 id="package-development">Package Development<a class="anchor" aria-label="anchor" href="#package-development"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Iterative development (refreshes namespace without reinstall)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run tests</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">test</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Full R CMD check before publishing</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">check</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Install locally to mirror user experience</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">evolveTrial</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Regenerate documentation site after API changes</span></span>
<span><span class="fu">pkgdown</span><span class="fu">::</span><span class="fu"><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">build_site</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Render README.Rmd to README.md</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">build_readme</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="running-scripts">Running Scripts<a class="anchor" aria-label="anchor" href="#running-scripts"></a></h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Isolated environment for scenario grids or one-off analyses</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="ex">Rscript</span> path/to/script.R</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run a single test file</span></span>
<span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_file.html" class="external-link">test_file</a></span><span class="op">(</span><span class="st">"tests/testthat/test-estimate-vsref-gates.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run tests matching a pattern</span></span>
<span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_package.html" class="external-link">test_local</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="st">"utils"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="coding-conventions">Coding Conventions<a class="anchor" aria-label="anchor" href="#coding-conventions"></a></h2>
<ul><li>
<strong>Style</strong>: Follow tidyverse conventions (two-space indentation, <code>{</code> on same line, <code>snake_case</code> identifiers like <code>min_person_time_frac_per_arm</code>)</li>
<li>
<strong>Utilities</strong>: Reuse package helpers (<code>%||%</code> for fallback, <code>coalesce_num()</code> for numeric coalescing, <code><a href="reference/resolve_gate_vec.html">resolve_gate_vec()</a></code> for gate parameter resolution) instead of reimplementing</li>
<li>
<strong>Diagnostics</strong>: Keep <code><a href="https://rdrr.io/r/base/message.html" class="external-link">message()</a></code> calls concise and prefixed (e.g., <code>[vsREF gate]</code>)</li>
<li>
<strong>Argument Threading</strong>: When adding parameters, add them to <code><a href="reference/run_simulation_pure.html">run_simulation_pure()</a></code> formals so downstream helpers can access them via <code><a href="https://rdrr.io/r/utils/modifyList.html" class="external-link">modifyList()</a></code>
</li>
<li>
<strong>Documentation</strong>: Use roxygen2 markdown format; document all exported functions and user-facing helpers</li>
<li>
<strong>Parameter Naming</strong>: Use harmonized naming scheme across comparison paths (e.g., <code>efficacy_threshold_hc_prob</code>, <code>futility_threshold_hc_prob</code>)</li>
</ul></div>
<div class="section level2">
<h2 id="simulation-configuration">Simulation Configuration<a class="anchor" aria-label="anchor" href="#simulation-configuration"></a></h2>
<p>Key design parameters threaded through <code><a href="reference/run_simulation_pure.html">run_simulation_pure()</a></code> and <code>interim_check()</code>:</p>
<ul><li>
<strong>Arms &amp; Comparison</strong>: <code>arm_names</code>, <code>reference_arm_name</code>, <code>compare_arms_option</code> (TRUE = vs-reference, FALSE = single-arm)</li>
<li>
<strong>Truth &amp; Priors</strong>: <code>weibull_shape_true_arms</code>, <code>weibull_median_true_arms</code>, <code>prior_alpha_params_model</code>, <code>prior_beta_params_model</code>
</li>
<li>
<strong>Thresholds</strong> (harmonized naming):
<ul><li>vs-reference: <code>efficacy_threshold_vs_ref_prob</code>, <code>futility_threshold_vs_ref_prob</code>, <code>compare_arms_futility_margin</code>
</li>
<li>single-arm: <code>efficacy_threshold_hc_prob</code>, <code>futility_threshold_hc_prob</code>, <code>null_median_arms</code>, <code>futility_median_arms</code>
</li>
<li>
<strong>Deprecated (still supported with warnings)</strong>: <code>efficacy_threshold_current_prob_hc</code>, <code>posterior_futility_threshold_hc</code>
</li>
</ul></li>
<li>
<strong>Gates</strong> (now use proportional scaling for both paths):
<ul><li>Per-arm gates: <code>min_events_per_arm</code>, <code>min_median_followup_per_arm</code>, <code>min_person_time_frac_per_arm</code> (used by both vs-reference and single-arm)</li>
<li>Legacy global gates: <code>min_events_hc</code>, <code>min_median_followup_hc</code>, <code>min_patients_for_analysis</code> (single-arm only)</li>
<li>
<strong>Deprecated (still supported with warnings)</strong>: <code>min_events_for_analysis</code>, <code>min_median_followup</code>
</li>
<li>
<strong>Proportional Scaling</strong>: When <code>min_events_per_arm</code> or <code>min_person_time_frac_per_arm</code> are scalar, they are automatically scaled by <code>randomization_probs</code> to account for unbalanced randomization</li>
</ul></li>
<li>
<strong>Scheduling</strong>: <code>interim_calendar_beat</code> (fixed spacing) or <code>person_time_milestones</code> (data-driven)</li>
<li>
<strong>Sample Size</strong>: <code>max_total_patients_per_arm</code>, <code>cohort_size_per_arm</code>, <code>overall_accrual_rate</code>, <code>randomization_probs</code>
</li>
</ul></div>
<div class="section level2">
<h2 id="gate-scaling-behavior">Gate Scaling Behavior<a class="anchor" aria-label="anchor" href="#gate-scaling-behavior"></a></h2>
<p>As of recent updates, <strong>both vs-reference and single-arm paths apply proportional gate scaling</strong> when scalar gate values are provided:</p>
<ul><li>
<strong>What gets scaled</strong>: <code>min_events_per_arm</code> and <code>min_person_time_frac_per_arm</code> (when provided as scalars)</li>
<li>
<strong>What doesn’t get scaled</strong>: <code>min_median_followup_per_arm</code> (followup time is independent of randomization ratio)</li>
<li>
<strong>How scaling works</strong>: If you specify <code>min_events_per_arm = 10</code> with <code>randomization_probs = c(Control = 0.3, Treatment = 0.7)</code>, the helper <code><a href="reference/resolve_gate_vec.html">resolve_gate_vec()</a></code> (in <code>R/gate_diagnostics.R</code>) will scale gates proportionally: arms with lower randomization probabilities get proportionally lower gates</li>
<li>
<strong>When to use named vectors</strong>: To override proportional scaling, provide a named vector (e.g., <code>min_events_per_arm = c(Control = 8, Treatment = 12)</code>)</li>
</ul><p>This ensures fairness when comparing arms with unbalanced randomization, and unifies behavior across comparison paths.</p>
</div>
<div class="section level2">
<h2 id="testing-approach">Testing Approach<a class="anchor" aria-label="anchor" href="#testing-approach"></a></h2>
<p>New decision logic or gating features require regression tests in <code>tests/testthat/</code>. Prioritize: - Multi-arm comparisons with reference arm switches - Proportional gate scaling across unbalanced arms (see <code>test-single-arm-gates.R</code> and <code>test-path-parity.R</code>) - Predictive probability fallback triggers - Use deterministic seeds (<code>set.seed(4242)</code>) and low simulation counts (e.g., <code>num_simulations = 50</code>) for unit tests - Document required outputs (PET, alpha, expected N) in <code>expect_*()</code> calls to catch behavior shifts - Parity tests ensure single-arm and vs-reference paths maintain consistent behavior</p>
</div>
<div class="section level2">
<h2 id="project-management">Project Management<a class="anchor" aria-label="anchor" href="#project-management"></a></h2>
<ul><li>
<strong>Dependencies</strong>: Managed via <code>renv/</code> for reproducibility; <code>renv::restore()</code> to sync</li>
<li>
<strong>Documentation</strong>: <code>man/</code> holds function docs; <code>vignettes/</code> contains long-form guides; <code>_pkgdown.yml</code> configures the browsable site</li>
<li>
<strong>Artifacts</strong>: Keep ad-hoc scenario grids and analysis scripts in project root or <code>inst/</code>; exclude from package namespace</li>
<li>
<strong>Commit Style</strong>: Imperative, present-tense titles under 72 characters (e.g., “Add one-time interval rebalancing support”); group related code/docs/tests into single commits; link to upstream issues for context</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Naim Rashid.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

