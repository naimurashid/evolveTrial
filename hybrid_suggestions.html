<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Hybrid Single-to-Between Arm Bayesian Adaptive Trial Design: Complete Specification • evolveTrial</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Hybrid Single-to-Between Arm Bayesian Adaptive Trial Design: Complete Specification"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">evolveTrial</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/design-overview.html">design-overview</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Hybrid Single-to-Between Arm Bayesian Adaptive Trial Design: Complete Specification</h1>

    </div>

<div id="hybrid-single-to-between-arm-bayesian-adaptive-trial-design-complete-specification" class="section level1">

<div class="section level2">
<h2 id="table-of-contents">Table of Contents<a class="anchor" aria-label="anchor" href="#table-of-contents"></a></h2>
<ol style="list-style-type: decimal"><li><a href="#id_1-design-overview">Design Overview</a></li>
<li><a href="#id_2-mathematical-framework">Mathematical Framework</a></li>
<li><a href="#id_3-decision-rules">Decision Rules</a></li>
<li><a href="#id_4-state-machine-architecture">State Machine Architecture</a></li>
<li><a href="#id_5-predictive-probability-engine">Predictive Probability Engine</a></li>
<li><a href="#id_6-software-architecture">Software Architecture</a></li>
<li><a href="#id_7-baton-calibration">BATON Calibration</a></li>
<li><a href="#id_8-implementation-phases">Implementation Phases</a></li>
<li><a href="#id_9-testing-strategy">Testing Strategy</a></li>
</ol><hr></div>
<div class="section level2">
<h2 id="id_1-design-overview">1. Design Overview<a class="anchor" aria-label="anchor" href="#id_1-design-overview"></a></h2>
<div class="section level3">
<h3 id="id_11-motivation">1.1 Motivation<a class="anchor" aria-label="anchor" href="#id_11-motivation"></a></h3>
<p>In resource-constrained settings, investigators often prefer within-arm comparisons to historical controls because they require fewer samples and complete more quickly than between-arm comparisons. However, between-arm comparisons provide stronger evidence. This hybrid design allows:</p>
<ol style="list-style-type: decimal"><li>
<strong>Initial phase</strong>: Monitor each arm against its historical benchmark (single-arm view) while simultaneously tracking between-arm contrasts</li>
<li>
<strong>Transition decision</strong>: Once single-arm efficacy is established, use accumulated data to determine whether extending to a powered between-arm comparison is worthwhile</li>
<li>
<strong>Extension phase</strong>: If warranted, continue enrollment to complete the between-arm comparison</li>
</ol></div>
<div class="section level3">
<h3 id="id_12-key-design-features">1.2 Key Design Features<a class="anchor" aria-label="anchor" href="#id_12-key-design-features"></a></h3>
<table class="table"><colgroup><col width="40%"><col width="59%"></colgroup><thead><tr class="header"><th>Feature</th>
<th>Description</th>
</tr></thead><tbody><tr class="odd"><td><strong>Randomization</strong></td>
<td>Always randomize among experimental arms from trial start</td>
</tr><tr class="even"><td><strong>Dual monitoring</strong></td>
<td>Compute both within-arm (vs historical) and between-arm posteriors at every interim</td>
</tr><tr class="odd"><td><strong>Historical controls</strong></td>
<td>Fixed, pre-specified benchmarks (not modeled as random)</td>
</tr><tr class="even"><td><strong>Transition trigger</strong></td>
<td>Configurable: any arm succeeds, all arms succeed, or k-of-K</td>
</tr><tr class="odd"><td><strong>Conversion decision</strong></td>
<td>Based on predictive probability of between-arm success</td>
</tr><tr class="even"><td><strong>Sample size adaptation</strong></td>
<td>Determine additional N needed for between-arm comparison at transition</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_13-trial-flow">1.3 Trial Flow<a class="anchor" aria-label="anchor" href="#id_13-trial-flow"></a></h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                              TRIAL FLOW                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐                                                             │
│  │ Trial Start │                                                             │
│  └──────┬──────┘                                                             │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     STATE: SINGLE-ARM PHASE                          │    │
│  │                                                                       │    │
│  │  • Randomize patients to arms A, B, ... (equal or RAR)               │    │
│  │  • At each interim, compute:                                          │    │
│  │      - P(HR_k^hist &lt; c_k | data) for each arm k                      │    │
│  │      - P(HR_AB &lt; 1 | data) [passive monitoring]                      │    │
│  │  • Apply single-arm efficacy/futility rules                          │    │
│  │                                                                       │    │
│  └─────────────────────────┬───────────────────────────────────────────┘    │
│                            │                                                 │
│         ┌──────────────────┼──────────────────┐                             │
│         │                  │                  │                             │
│         ▼                  ▼                  ▼                             │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────────────────────────┐   │
│  │All arms fail│   │ Max N with  │   │  Single-arm efficacy trigger    │   │
│  │  futility   │   │  no trigger │   │  (e.g., any arm succeeds)       │   │
│  └──────┬──────┘   └──────┬──────┘   └───────────────┬─────────────────┘   │
│         │                 │                          │                      │
│         ▼                 ▼                          ▼                      │
│  ┌─────────────────────────────┐   ┌─────────────────────────────────────┐ │
│  │    STATE: STOP (futility)   │   │   STATE: CONSIDER CONVERSION        │ │
│  │    No efficacy claims       │   │                                      │ │
│  └─────────────────────────────┘   │   • Compute π_pred(N_add) for       │ │
│                                     │     candidate additional sample     │ │
│                                     │     sizes                           │ │
│                                     │   • Determine go/no-go              │ │
│                                     └───────────────┬─────────────────────┘ │
│                                                     │                       │
│                              ┌──────────────────────┴────────────────┐      │
│                              │                                       │      │
│                              ▼                                       ▼      │
│               ┌───────────────────────────┐      ┌────────────────────────┐│
│               │  π_pred &lt; pp_nogo         │      │  π_pred ≥ pp_go        ││
│               │  (not worth continuing)   │      │  (worth continuing)    ││
│               └─────────────┬─────────────┘      └───────────┬────────────┘│
│                             │                                │             │
│                             ▼                                ▼             │
│               ┌───────────────────────────┐    ┌─────────────────────────┐ │
│               │  STATE: STOP              │    │  STATE: BETWEEN-ARM     │ │
│               │  Report single-arm        │    │  PHASE                  │ │
│               │  conclusions only         │    │                         │ │
│               └───────────────────────────┘    │  • Continue enrollment  │ │
│                                                │    to selected N_max    │ │
│                                                │  • Monitor between-arm  │ │
│                                                │    efficacy/futility    │ │
│                                                └────────────┬────────────┘ │
│                                                             │              │
│                                                             ▼              │
│                                                ┌─────────────────────────┐ │
│                                                │  STATE: STOP            │ │
│                                                │  Report single-arm AND  │ │
│                                                │  between-arm conclusions│ │
│                                                └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_2-mathematical-framework">2. Mathematical Framework<a class="anchor" aria-label="anchor" href="#id_2-mathematical-framework"></a></h2>
<div class="section level3">
<h3 id="id_21-notation">2.1 Notation<a class="anchor" aria-label="anchor" href="#id_21-notation"></a></h3>
<table class="table"><colgroup><col width="38%"><col width="61%"></colgroup><thead><tr class="header"><th>Symbol</th>
<th>Description</th>
</tr></thead><tbody><tr class="odd"><td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">k = 1, \ldots, K</annotation></semantics></math></td>
<td>Arm index (<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>≥</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">K \geq 2</annotation></semantics></math>, all experimental)</td>
</tr><tr class="even"><td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>λ</mi><mi>k</mi></msub><annotation encoding="application/x-tex">\lambda_k</annotation></semantics></math></td>
<td>Hazard rate for arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math> (random, to be estimated)</td>
</tr><tr class="odd"><td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>λ</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub><annotation encoding="application/x-tex">\lambda_{\text{hist},k}</annotation></semantics></math></td>
<td>Historical control hazard for arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math> (fixed, pre-specified)</td>
</tr><tr class="even"><td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>k</mi></msub><annotation encoding="application/x-tex">n_k</annotation></semantics></math></td>
<td>Number of events observed in arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math></td>
</tr><tr class="odd"><td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>T</mi><mi>k</mi></msub><annotation encoding="application/x-tex">T_k</annotation></semantics></math></td>
<td>Total exposure time (person-time) in arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math></td>
</tr><tr class="even"><td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>c</mi><mi>k</mi></msub><annotation encoding="application/x-tex">c_k</annotation></semantics></math></td>
<td>Target hazard ratio threshold vs historical (e.g., 0.8)</td>
</tr><tr class="odd"><td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mtext mathvariant="normal">HR</mtext><mi>k</mi><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">hist</mtext><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><annotation encoding="application/x-tex">\text{HR}_k^{(\text{hist})}</annotation></semantics></math></td>
<td>Hazard ratio of arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math> vs historical: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>k</mi></msub><mi>/</mi><msub><mi>λ</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\lambda_k / \lambda_{\text{hist},k}</annotation></semantics></math></td>
</tr><tr class="even"><td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mtext mathvariant="normal">HR</mtext><mrow><mi>j</mi><mi>l</mi></mrow></msub><annotation encoding="application/x-tex">\text{HR}_{jl}</annotation></semantics></math></td>
<td>Hazard ratio between arms: <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>j</mi></msub><mi>/</mi><msub><mi>λ</mi><mi>l</mi></msub></mrow><annotation encoding="application/x-tex">\lambda_j / \lambda_l</annotation></semantics></math></td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_22-survival-model-exponential-with-gamma-prior">2.2 Survival Model: Exponential with Gamma Prior<a class="anchor" aria-label="anchor" href="#id_22-survival-model-exponential-with-gamma-prior"></a></h3>
<p><strong>Assumption</strong>: Survival times follow an exponential distribution with arm-specific hazard rates.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><mo>∣</mo><msub><mi>λ</mi><mi>k</mi></msub><mo>∼</mo><mtext mathvariant="normal">Exponential</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>λ</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">T_{ik} \mid \lambda_k \sim \text{Exponential}(\lambda_k)</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>T</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><annotation encoding="application/x-tex">T_{ik}</annotation></semantics></math> is the survival time for patient <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math> in arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>.</p>
<p><strong>Prior</strong>: Gamma prior on each hazard rate (conjugate):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>k</mi></msub><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo>,</mo><msub><mi>b</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_k \sim \text{Gamma}(a_0, b_0)</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>0</mn></msub><mo>,</mo><msub><mi>b</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">a_0, b_0</annotation></semantics></math> are typically small (e.g., <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>0</mn></msub><mo>=</mo><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><mn>0.001</mn></mrow><annotation encoding="application/x-tex">a_0 = b_0 = 0.001</annotation></semantics></math>) for a vague prior.</p>
<p><strong>Likelihood</strong>: For <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>k</mi></msub><annotation encoding="application/x-tex">n_k</annotation></semantics></math> events and total exposure <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>T</mi><mi>k</mi></msub><annotation encoding="application/x-tex">T_k</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>λ</mi><mi>k</mi></msub><mo>∣</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">)</mo></mrow><mo>∝</mo><msubsup><mi>λ</mi><mi>k</mi><msub><mi>n</mi><mi>k</mi></msub></msubsup><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>−</mo><msub><mi>λ</mi><mi>k</mi></msub><msub><mi>T</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">L(\lambda_k \mid \text{data}) \propto \lambda_k^{n_k} \exp(-\lambda_k T_k)</annotation></semantics></math></p>
<p><strong>Posterior</strong>: By conjugacy:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>k</mi></msub><mo>∣</mo><mtext mathvariant="normal">data</mtext><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>k</mi></msub><mo>,</mo><msub><mi>b</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_k \mid \text{data} \sim \text{Gamma}(a_k, b_k)</annotation></semantics></math></p>
<p>where: - <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>k</mi></msub><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub><mo>+</mo><msub><mi>n</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">a_k = a_0 + n_k</annotation></semantics></math> (shape parameter) - <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>k</mi></msub><mo>=</mo><msub><mi>b</mi><mn>0</mn></msub><mo>+</mo><msub><mi>T</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">b_k = b_0 + T_k</annotation></semantics></math> (rate parameter)</p>
<p><strong>Sufficient statistics</strong>: The posterior is fully characterized by <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>k</mi></msub><mo>,</mo><msub><mi>b</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(a_k, b_k)</annotation></semantics></math>.</p>
</div>
<div class="section level3">
<h3 id="id_23-historical-control-specification">2.3 Historical Control Specification<a class="anchor" aria-label="anchor" href="#id_23-historical-control-specification"></a></h3>
<p>The historical control hazard <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>λ</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub><annotation encoding="application/x-tex">\lambda_{\text{hist},k}</annotation></semantics></math> is a <strong>fixed constant</strong>, typically derived from:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub><mo>=</mo><mfrac><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><msub><mi>m</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub></mfrac></mrow><annotation encoding="application/x-tex">\lambda_{\text{hist},k} = \frac{\log(2)}{m_{\text{hist},k}}</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>m</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub><annotation encoding="application/x-tex">m_{\text{hist},k}</annotation></semantics></math> is the historical median survival time for the population relevant to arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>.</p>
<p><strong>Key point</strong>: We do NOT place a prior on <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>λ</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub><annotation encoding="application/x-tex">\lambda_{\text{hist},k}</annotation></semantics></math>. It enters calculations only as a fixed benchmark.</p>
</div>
<div class="section level3">
<h3 id="id_24-within-arm-comparison-vs-fixed-historical">2.4 Within-Arm Comparison (vs Fixed Historical)<a class="anchor" aria-label="anchor" href="#id_24-within-arm-comparison-vs-fixed-historical"></a></h3>
<p><strong>Hazard ratio</strong>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mtext mathvariant="normal">HR</mtext><mi>k</mi><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">hist</mtext><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>=</mo><mfrac><msub><mi>λ</mi><mi>k</mi></msub><msub><mi>λ</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub></mfrac></mrow><annotation encoding="application/x-tex">\text{HR}_k^{(\text{hist})} = \frac{\lambda_k}{\lambda_{\text{hist},k}}</annotation></semantics></math></p>
<p><strong>Decision quantity</strong> — probability that HR is below target threshold <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>c</mi><mi>k</mi></msub><annotation encoding="application/x-tex">c_k</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mi>k</mi><mtext mathvariant="normal">single</mtext></msubsup><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mtext mathvariant="normal">HR</mtext><mi>k</mi><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">hist</mtext><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>&lt;</mo><msub><mi>c</mi><mi>k</mi></msub><mo>∣</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>λ</mi><mi>k</mi></msub><mo>&lt;</mo><msub><mi>c</mi><mi>k</mi></msub><mo>⋅</mo><msub><mi>λ</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub><mo>∣</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p_k^{\text{single}} = P\left(\text{HR}_k^{(\text{hist})} &lt; c_k \mid \text{data}\right) = P\left(\lambda_k &lt; c_k \cdot \lambda_{\text{hist},k} \mid \text{data}\right)</annotation></semantics></math></p>
<p><strong>Closed-form computation</strong>:</p>
<p>Since <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>k</mi></msub><mo>∣</mo><mtext mathvariant="normal">data</mtext><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>k</mi></msub><mo>,</mo><msub><mi>b</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_k \mid \text{data} \sim \text{Gamma}(a_k, b_k)</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mi>k</mi><mtext mathvariant="normal">single</mtext></msubsup><mo>=</mo><msub><mi>F</mi><mtext mathvariant="normal">Gamma</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>c</mi><mi>k</mi></msub><mo>⋅</mo><msub><mi>λ</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub><mo>;</mo><msub><mi>a</mi><mi>k</mi></msub><mo>,</mo><msub><mi>b</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p_k^{\text{single}} = F_{\text{Gamma}}\left(c_k \cdot \lambda_{\text{hist},k}; a_k, b_k\right)</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mtext mathvariant="normal">Gamma</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>;</mo><mi>a</mi><mo>,</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">F_{\text{Gamma}}(x; a, b)</annotation></semantics></math> is the CDF of the Gamma distribution with shape <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math> and rate <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>.</p>
<p><strong>In R</strong>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_single</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">pgamma</a></span><span class="op">(</span><span class="va">c_k</span> <span class="op">*</span> <span class="va">lambda_hist_k</span>, shape <span class="op">=</span> <span class="va">a_k</span>, rate <span class="op">=</span> <span class="va">b_k</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_25-between-arm-comparison">2.5 Between-Arm Comparison<a class="anchor" aria-label="anchor" href="#id_25-between-arm-comparison"></a></h3>
<p><strong>Hazard ratio</strong> between arms <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">HR</mtext><mrow><mi>j</mi><mi>l</mi></mrow></msub><mo>=</mo><mfrac><msub><mi>λ</mi><mi>j</mi></msub><msub><mi>λ</mi><mi>l</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\text{HR}_{jl} = \frac{\lambda_j}{\lambda_l}</annotation></semantics></math></p>
<p><strong>Decision quantity</strong>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mrow><mi>j</mi><mi>l</mi></mrow><mtext mathvariant="normal">between</mtext></msubsup><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mtext mathvariant="normal">HR</mtext><mrow><mi>j</mi><mi>l</mi></mrow></msub><mo>&lt;</mo><mn>1</mn><mo>∣</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>λ</mi><mi>j</mi></msub><msub><mi>λ</mi><mi>l</mi></msub></mfrac><mo>&lt;</mo><mn>1</mn><mo>∣</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p_{jl}^{\text{between}} = P\left(\text{HR}_{jl} &lt; 1 \mid \text{data}\right) = P\left(\frac{\lambda_j}{\lambda_l} &lt; 1 \mid \text{data}\right)</annotation></semantics></math></p>
<p><strong>Distribution of the ratio</strong>:</p>
<p>If <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>j</mi></msub><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>j</mi></msub><mo>,</mo><msub><mi>b</mi><mi>j</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_j \sim \text{Gamma}(a_j, b_j)</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>l</mi></msub><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>l</mi></msub><mo>,</mo><msub><mi>b</mi><mi>l</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_l \sim \text{Gamma}(a_l, b_l)</annotation></semantics></math> independently, then:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><msub><mi>λ</mi><mi>j</mi></msub><mi>/</mi><msub><mi>b</mi><mi>j</mi></msub></mrow><mrow><msub><mi>λ</mi><mi>l</mi></msub><mi>/</mi><msub><mi>b</mi><mi>l</mi></msub></mrow></mfrac><mo>∼</mo><mtext mathvariant="normal">BetaPrime</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>j</mi></msub><mo>,</mo><msub><mi>a</mi><mi>l</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{\lambda_j / b_j}{\lambda_l / b_l} \sim \text{BetaPrime}(a_j, a_l)</annotation></semantics></math></p>
<p>Or equivalently, using the F-distribution relationship:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mi>a</mi><mi>l</mi></msub><msub><mi>a</mi><mi>j</mi></msub></mfrac><mo>⋅</mo><mfrac><msub><mi>b</mi><mi>j</mi></msub><msub><mi>b</mi><mi>l</mi></msub></mfrac><mo>⋅</mo><mfrac><msub><mi>λ</mi><mi>j</mi></msub><msub><mi>λ</mi><mi>l</mi></msub></mfrac><mo>∼</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><msub><mi>a</mi><mi>j</mi></msub><mo>,</mo><mn>2</mn><msub><mi>a</mi><mi>l</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{a_l}{a_j} \cdot \frac{b_j}{b_l} \cdot \frac{\lambda_j}{\lambda_l} \sim F(2a_j, 2a_l)</annotation></semantics></math></p>
<p><strong>Closed-form computation</strong>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>λ</mi><mi>j</mi></msub><msub><mi>λ</mi><mi>l</mi></msub></mfrac><mo>&lt;</mo><mi>c</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>F</mi><mi>F</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>c</mi><mo>⋅</mo><mfrac><msub><mi>b</mi><mi>j</mi></msub><msub><mi>b</mi><mi>l</mi></msub></mfrac><mo>⋅</mo><mfrac><msub><mi>a</mi><mi>l</mi></msub><msub><mi>a</mi><mi>j</mi></msub></mfrac><mo>;</mo><mn>2</mn><msub><mi>a</mi><mi>j</mi></msub><mo>,</mo><mn>2</mn><msub><mi>a</mi><mi>l</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P\left(\frac{\lambda_j}{\lambda_l} &lt; c\right) = F_F\left(c \cdot \frac{b_j}{b_l} \cdot \frac{a_l}{a_j}; 2a_j, 2a_l\right)</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mi>F</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>;</mo><msub><mi>d</mi><mn>1</mn></msub><mo>,</mo><msub><mi>d</mi><mn>2</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">F_F(x; d_1, d_2)</annotation></semantics></math> is the CDF of the F-distribution with degrees of freedom <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mn>1</mn></msub><annotation encoding="application/x-tex">d_1</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>d</mi><mn>2</mn></msub><annotation encoding="application/x-tex">d_2</annotation></semantics></math>.</p>
<p>For <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">c = 1</annotation></semantics></math> (testing whether arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math> is superior to arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mrow><mi>j</mi><mi>l</mi></mrow><mtext mathvariant="normal">between</mtext></msubsup><mo>=</mo><msub><mi>F</mi><mi>F</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>b</mi><mi>j</mi></msub><msub><mi>b</mi><mi>l</mi></msub></mfrac><mo>⋅</mo><mfrac><msub><mi>a</mi><mi>l</mi></msub><msub><mi>a</mi><mi>j</mi></msub></mfrac><mo>;</mo><mn>2</mn><msub><mi>a</mi><mi>j</mi></msub><mo>,</mo><mn>2</mn><msub><mi>a</mi><mi>l</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p_{jl}^{\text{between}} = F_F\left(\frac{b_j}{b_l} \cdot \frac{a_l}{a_j}; 2a_j, 2a_l\right)</annotation></semantics></math></p>
<p><strong>In R</strong>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_between</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html" class="external-link">pf</a></span><span class="op">(</span></span>
<span>  q <span class="op">=</span> <span class="op">(</span><span class="va">b_j</span> <span class="op">/</span> <span class="va">b_l</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">a_l</span> <span class="op">/</span> <span class="va">a_j</span><span class="op">)</span>,</span>
<span>  df1 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_j</span>,</span>
<span>  df2 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_l</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>More general form</strong> (for HR &lt; c):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compute_p_hr_less_than_c</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a_j</span>, <span class="va">b_j</span>, <span class="va">a_l</span>, <span class="va">b_l</span>, <span class="va">c</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html" class="external-link">pf</a></span><span class="op">(</span></span>
<span>    q <span class="op">=</span> <span class="va">c</span> <span class="op">*</span> <span class="op">(</span><span class="va">b_j</span> <span class="op">/</span> <span class="va">b_l</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">a_l</span> <span class="op">/</span> <span class="va">a_j</span><span class="op">)</span>,</span>
<span>    df1 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_j</span>,</span>
<span>    df2 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_l</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_26-summary-of-posterior-computations">2.6 Summary of Posterior Computations<a class="anchor" aria-label="anchor" href="#id_26-summary-of-posterior-computations"></a></h3>
<table class="table"><colgroup><col width="27%"><col width="24%"><col width="48%"></colgroup><thead><tr class="header"><th>Quantity</th>
<th>Formula</th>
<th>R Implementation</th>
</tr></thead><tbody><tr class="odd"><td>Posterior shape</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>k</mi></msub><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub><mo>+</mo><msub><mi>n</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">a_k = a_0 + n_k</annotation></semantics></math></td>
<td><code>a_k &lt;- a_0 + n_events_k</code></td>
</tr><tr class="even"><td>Posterior rate</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>k</mi></msub><mo>=</mo><msub><mi>b</mi><mn>0</mn></msub><mo>+</mo><msub><mi>T</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">b_k = b_0 + T_k</annotation></semantics></math></td>
<td><code>b_k &lt;- b_0 + exposure_k</code></td>
</tr><tr class="odd"><td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mtext mathvariant="normal">HR</mtext><mi>k</mi><mtext mathvariant="normal">hist</mtext></msubsup><mo>&lt;</mo><msub><mi>c</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(\text{HR}_k^{\text{hist}} &lt; c_k)</annotation></semantics></math></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mtext mathvariant="normal">Gamma</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>c</mi><mi>k</mi></msub><msub><mi>λ</mi><mrow><mtext mathvariant="normal">hist</mtext><mo>,</mo><mi>k</mi></mrow></msub><mo>;</mo><msub><mi>a</mi><mi>k</mi></msub><mo>,</mo><msub><mi>b</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">F_{\text{Gamma}}(c_k \lambda_{\text{hist},k}; a_k, b_k)</annotation></semantics></math></td>
<td><code>pgamma(c_k * lambda_hist_k, a_k, b_k)</code></td>
</tr><tr class="even"><td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mtext mathvariant="normal">HR</mtext><mrow><mi>j</mi><mi>l</mi></mrow></msub><mo>&lt;</mo><mi>c</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(\text{HR}_{jl} &lt; c)</annotation></semantics></math></td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mi>F</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>c</mi><mo>⋅</mo><mfrac><mrow><msub><mi>b</mi><mi>j</mi></msub><msub><mi>a</mi><mi>l</mi></msub></mrow><mrow><msub><mi>b</mi><mi>l</mi></msub><msub><mi>a</mi><mi>j</mi></msub></mrow></mfrac><mo>;</mo><mn>2</mn><msub><mi>a</mi><mi>j</mi></msub><mo>,</mo><mn>2</mn><msub><mi>a</mi><mi>l</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">F_F(c \cdot \frac{b_j a_l}{b_l a_j}; 2a_j, 2a_l)</annotation></semantics></math></td>
<td><code>pf(c * b_j/b_l * a_l/a_j, 2*a_j, 2*a_l)</code></td>
</tr></tbody></table><hr></div>
</div>
<div class="section level2">
<h2 id="id_3-decision-rules">3. Decision Rules<a class="anchor" aria-label="anchor" href="#id_3-decision-rules"></a></h2>
<div class="section level3">
<h3 id="id_31-single-arm-decision-rules">3.1 Single-Arm Decision Rules<a class="anchor" aria-label="anchor" href="#id_31-single-arm-decision-rules"></a></h3>
<p>At each interim analysis, for each active arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>:</p>
<p><strong>Efficacy</strong>: Arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math> demonstrates efficacy vs historical if:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mi>k</mi><mtext mathvariant="normal">single</mtext></msubsup><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mtext mathvariant="normal">HR</mtext><mi>k</mi><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">hist</mtext><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>&lt;</mo><msub><mi>c</mi><mi>k</mi></msub><mo>∣</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">)</mo></mrow><mo>&gt;</mo><msubsup><mi>γ</mi><mtext mathvariant="normal">eff</mtext><mtext mathvariant="normal">single</mtext></msubsup></mrow><annotation encoding="application/x-tex">p_k^{\text{single}} = P\left(\text{HR}_k^{(\text{hist})} &lt; c_k \mid \text{data}\right) &gt; \gamma_{\text{eff}}^{\text{single}}</annotation></semantics></math></p>
<p><strong>Futility</strong>: Arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math> is dropped for futility if:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mi>k</mi><mtext mathvariant="normal">single</mtext></msubsup><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mtext mathvariant="normal">HR</mtext><mi>k</mi><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">hist</mtext><mo stretchy="true" form="postfix">)</mo></mrow></msubsup><mo>&lt;</mo><msub><mi>c</mi><mi>k</mi></msub><mo>∣</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">)</mo></mrow><mo>&lt;</mo><msubsup><mi>γ</mi><mtext mathvariant="normal">fut</mtext><mtext mathvariant="normal">single</mtext></msubsup></mrow><annotation encoding="application/x-tex">p_k^{\text{single}} = P\left(\text{HR}_k^{(\text{hist})} &lt; c_k \mid \text{data}\right) &lt; \gamma_{\text{fut}}^{\text{single}}</annotation></semantics></math></p>
<p><strong>Typical values</strong>: - <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>k</mi></msub><mo>=</mo><mn>0.8</mn></mrow><annotation encoding="application/x-tex">c_k = 0.8</annotation></semantics></math> (target 20% improvement over historical) - <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>γ</mi><mtext mathvariant="normal">eff</mtext><mtext mathvariant="normal">single</mtext></msubsup><mo>=</mo><mn>0.90</mn></mrow><annotation encoding="application/x-tex">\gamma_{\text{eff}}^{\text{single}} = 0.90</annotation></semantics></math> (90% posterior probability for efficacy) - <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>γ</mi><mtext mathvariant="normal">fut</mtext><mtext mathvariant="normal">single</mtext></msubsup><mo>=</mo><mn>0.10</mn></mrow><annotation encoding="application/x-tex">\gamma_{\text{fut}}^{\text{single}} = 0.10</annotation></semantics></math> (10% posterior probability for futility)</p>
</div>
<div class="section level3">
<h3 id="id_32-between-arm-decision-rules">3.2 Between-Arm Decision Rules<a class="anchor" aria-label="anchor" href="#id_32-between-arm-decision-rules"></a></h3>
<p>At each interim analysis (primarily in STATE_BETWEEN, but computed throughout):</p>
<p><strong>Efficacy</strong>: Arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math> is superior to arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math> if:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mrow><mi>j</mi><mi>l</mi></mrow><mtext mathvariant="normal">between</mtext></msubsup><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mtext mathvariant="normal">HR</mtext><mrow><mi>j</mi><mi>l</mi></mrow></msub><mo>&lt;</mo><mn>1</mn><mo>∣</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">)</mo></mrow><mo>&gt;</mo><msubsup><mi>γ</mi><mtext mathvariant="normal">eff</mtext><mtext mathvariant="normal">between</mtext></msubsup></mrow><annotation encoding="application/x-tex">p_{jl}^{\text{between}} = P\left(\text{HR}_{jl} &lt; 1 \mid \text{data}\right) &gt; \gamma_{\text{eff}}^{\text{between}}</annotation></semantics></math></p>
<p><strong>Futility</strong>: Stop between-arm comparison for futility if:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mrow><mi>j</mi><mi>l</mi></mrow><mtext mathvariant="normal">between</mtext></msubsup><mo>&lt;</mo><msubsup><mi>γ</mi><mtext mathvariant="normal">fut</mtext><mtext mathvariant="normal">between</mtext></msubsup></mrow><annotation encoding="application/x-tex">p_{jl}^{\text{between}} &lt; \gamma_{\text{fut}}^{\text{between}}</annotation></semantics></math></p>
<p><strong>Typical values</strong>: - <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>γ</mi><mtext mathvariant="normal">eff</mtext><mtext mathvariant="normal">between</mtext></msubsup><mo>=</mo><mn>0.975</mn></mrow><annotation encoding="application/x-tex">\gamma_{\text{eff}}^{\text{between}} = 0.975</annotation></semantics></math> (more stringent for confirmatory) - <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>γ</mi><mtext mathvariant="normal">fut</mtext><mtext mathvariant="normal">between</mtext></msubsup><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\gamma_{\text{fut}}^{\text{between}} = 0.05</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="id_33-transition-trigger-rules">3.3 Transition Trigger Rules<a class="anchor" aria-label="anchor" href="#id_33-transition-trigger-rules"></a></h3>
<p>The trial moves from STATE_SINGLE to STATE_CONSIDER_CONVERSION when a trigger condition is met. Configurable options:</p>
<table class="table"><colgroup><col width="56%"><col width="44%"></colgroup><thead><tr class="header"><th>Trigger Type</th>
<th>Condition</th>
</tr></thead><tbody><tr class="odd"><td><code>"any_single_success"</code></td>
<td>At least one arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math> has <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mi>k</mi><mtext mathvariant="normal">single</mtext></msubsup><mo>&gt;</mo><msubsup><mi>γ</mi><mtext mathvariant="normal">eff</mtext><mtext mathvariant="normal">single</mtext></msubsup></mrow><annotation encoding="application/x-tex">p_k^{\text{single}} &gt; \gamma_{\text{eff}}^{\text{single}}</annotation></semantics></math></td>
</tr><tr class="even"><td><code>"all_single_success"</code></td>
<td>All active arms have <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>p</mi><mi>k</mi><mtext mathvariant="normal">single</mtext></msubsup><mo>&gt;</mo><msubsup><mi>γ</mi><mtext mathvariant="normal">eff</mtext><mtext mathvariant="normal">single</mtext></msubsup></mrow><annotation encoding="application/x-tex">p_k^{\text{single}} &gt; \gamma_{\text{eff}}^{\text{single}}</annotation></semantics></math></td>
</tr><tr class="odd"><td><code>"k_of_K"</code></td>
<td>At least <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math> of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math> arms meet single-arm efficacy</td>
</tr></tbody></table></div>
<div class="section level3">
<h3 id="id_34-conversion-decision-rules">3.4 Conversion Decision Rules<a class="anchor" aria-label="anchor" href="#id_34-conversion-decision-rules"></a></h3>
<p>At STATE_CONSIDER_CONVERSION, compute predictive probability <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext mathvariant="normal">pred</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>N</mi><mtext mathvariant="normal">add</mtext></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\pi_{\text{pred}}(N_{\text{add}})</annotation></semantics></math> for candidate additional sample sizes.</p>
<p><strong>Go decision</strong> (proceed to between-arm phase):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∃</mo><msub><mi>N</mi><mtext mathvariant="normal">add</mtext></msub><mo>∈</mo><msub><mi>𝒩</mi><mtext mathvariant="normal">candidates</mtext></msub><mo>:</mo><msub><mi>π</mi><mtext mathvariant="normal">pred</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>N</mi><mtext mathvariant="normal">add</mtext></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>≥</mo><msub><mi>π</mi><mtext mathvariant="normal">go</mtext></msub></mrow><annotation encoding="application/x-tex">\exists N_{\text{add}} \in \mathcal{N}_{\text{candidates}}: \pi_{\text{pred}}(N_{\text{add}}) \geq \pi_{\text{go}}</annotation></semantics></math></p>
<p>If multiple <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mtext mathvariant="normal">add</mtext></msub><annotation encoding="application/x-tex">N_{\text{add}}</annotation></semantics></math> satisfy this, select the smallest.</p>
<p><strong>No-go decision</strong> (stop with single-arm conclusions only):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munder><mo>max</mo><mrow><msub><mi>N</mi><mtext mathvariant="normal">add</mtext></msub><mo>∈</mo><msub><mi>𝒩</mi><mtext mathvariant="normal">candidates</mtext></msub></mrow></munder><msub><mi>π</mi><mtext mathvariant="normal">pred</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>N</mi><mtext mathvariant="normal">add</mtext></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>&lt;</mo><msub><mi>π</mi><mtext mathvariant="normal">nogo</mtext></msub></mrow><annotation encoding="application/x-tex">\max_{N_{\text{add}} \in \mathcal{N}_{\text{candidates}}} \pi_{\text{pred}}(N_{\text{add}}) &lt; \pi_{\text{nogo}}</annotation></semantics></math></p>
<p><strong>Typical values</strong>: - <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext mathvariant="normal">go</mtext></msub><mo>=</mo><mn>0.70</mn></mrow><annotation encoding="application/x-tex">\pi_{\text{go}} = 0.70</annotation></semantics></math> (70% chance of between-arm success to proceed) - <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext mathvariant="normal">nogo</mtext></msub><mo>=</mo><mn>0.20</mn></mrow><annotation encoding="application/x-tex">\pi_{\text{nogo}} = 0.20</annotation></semantics></math> (below 20% not worth continuing) - <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>𝒩</mi><mtext mathvariant="normal">candidates</mtext></msub><mo>=</mo><mo stretchy="false" form="prefix">{</mo><mn>30</mn><mo>,</mo><mn>40</mn><mo>,</mo><mn>50</mn><mo>,</mo><mi>…</mi><mo>,</mo><mn>100</mn><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\mathcal{N}_{\text{candidates}} = \{30, 40, 50, \ldots, 100\}</annotation></semantics></math> per arm</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_4-state-machine-architecture">4. State Machine Architecture<a class="anchor" aria-label="anchor" href="#id_4-state-machine-architecture"></a></h2>
<div class="section level3">
<h3 id="id_41-state-definitions">4.1 State Definitions<a class="anchor" aria-label="anchor" href="#id_41-state-definitions"></a></h3>
<pre><code>typedef enum {
  STATE_SINGLE,              // Primary monitoring on within-arm comparisons
  STATE_CONSIDER_CONVERSION, // Evaluating whether to extend to between-arm
  STATE_BETWEEN,             // Full between-arm comparison phase
  STATE_STOP                 // Trial complete
} TrialState;</code></pre>
</div>
<div class="section level3">
<h3 id="id_42-state-transition-logic">4.2 State Transition Logic<a class="anchor" aria-label="anchor" href="#id_42-state-transition-logic"></a></h3>
<pre><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                        STATE TRANSITION DIAGRAM                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                          ┌─────────────────┐                                │
│                          │  STATE_SINGLE   │                                │
│                          └────────┬────────┘                                │
│                                   │                                         │
│            ┌──────────────────────┼──────────────────────┐                  │
│            │                      │                      │                  │
│            ▼                      ▼                      ▼                  │
│   ┌────────────────┐    ┌────────────────┐    ┌─────────────────────┐      │
│   │ All arms hit   │    │ Max N reached  │    │ Transition trigger  │      │
│   │ futility       │    │ (no trigger)   │    │ met                 │      │
│   └───────┬────────┘    └───────┬────────┘    └──────────┬──────────┘      │
│           │                     │                        │                  │
│           │                     │                        ▼                  │
│           │                     │             ┌─────────────────────────┐   │
│           │                     │             │ STATE_CONSIDER_CONVERSION│   │
│           │                     │             └──────────┬──────────────┘   │
│           │                     │                        │                  │
│           │                     │         ┌──────────────┴──────────────┐   │
│           │                     │         │                             │   │
│           │                     │         ▼                             ▼   │
│           │                     │  ┌─────────────┐              ┌──────────┐│
│           │                     │  │ PP ≥ pp_go  │              │PP &lt; nogo ││
│           │                     │  └──────┬──────┘              └────┬─────┘│
│           │                     │         │                          │      │
│           │                     │         ▼                          │      │
│           │                     │  ┌─────────────────┐               │      │
│           │                     │  │  STATE_BETWEEN  │               │      │
│           │                     │  └────────┬────────┘               │      │
│           │                     │           │                        │      │
│           │                     │    ┌──────┴──────┐                 │      │
│           │                     │    │             │                 │      │
│           │                     │    ▼             ▼                 │      │
│           │                     │ ┌──────┐    ┌────────┐             │      │
│           │                     │ │Eff/  │    │ Max N  │             │      │
│           │                     │ │Fut   │    │reached │             │      │
│           │                     │ └──┬───┘    └───┬────┘             │      │
│           │                     │    │            │                  │      │
│           ▼                     ▼    ▼            ▼                  ▼      │
│        ┌────────────────────────────────────────────────────────────────┐   │
│        │                        STATE_STOP                              │   │
│        │  • Compile final conclusions (single-arm and/or between-arm)   │   │
│        └────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘</code></pre>
</div>
<div class="section level3">
<h3 id="id_43-pseudo-code-for-state-transitions">4.3 Pseudo-code for State Transitions<a class="anchor" aria-label="anchor" href="#id_43-pseudo-code-for-state-transitions"></a></h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">update_trial_state</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">state</span>,</span>
<span>    </span>
<span>    <span class="st">"STATE_SINGLE"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># Update posteriors</span></span>
<span>      <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/update_posteriors.html">update_posteriors</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Check single-arm futility (drop arms)</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="va">trial</span><span class="op">$</span><span class="va">active_arms</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">p_single</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">gamma_single_fut</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu">drop_arm</span><span class="op">(</span><span class="va">trial</span>, <span class="va">k</span>, reason <span class="op">=</span> <span class="st">"futility"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Check if all arms dropped</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">active_arms</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">state</span> <span class="op">&lt;-</span> <span class="st">"STATE_STOP"</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">conclusion</span> <span class="op">&lt;-</span> <span class="st">"all_arms_futile"</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Check transition trigger</span></span>
<span>      <span class="va">trigger_met</span> <span class="op">&lt;-</span> <span class="fu">check_transition_trigger</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">trigger_met</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">state</span> <span class="op">&lt;-</span> <span class="st">"STATE_CONSIDER_CONVERSION"</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Check max sample size</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">n_enrolled</span> <span class="op">&gt;=</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">n_max_single_phase</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">state</span> <span class="op">&lt;-</span> <span class="st">"STATE_STOP"</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">conclusion</span> <span class="op">&lt;-</span> <span class="st">"max_n_single_phase"</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Continue enrollment</span></span>
<span>      <span class="va">trial</span></span>
<span>    <span class="op">}</span>,</span>
<span>    </span>
<span>    <span class="st">"STATE_CONSIDER_CONVERSION"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># Compute predictive probability for each candidate N_add</span></span>
<span>      <span class="va">pp_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/compute_pp_curve.html">compute_pp_curve</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Find minimum N_add achieving pp_go (if any)</span></span>
<span>      <span class="va">viable_n</span> <span class="op">&lt;-</span> <span class="va">pp_results</span><span class="op">$</span><span class="va">n_add</span><span class="op">[</span><span class="va">pp_results</span><span class="op">$</span><span class="va">pp</span> <span class="op">&gt;=</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">pp_go</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">viable_n</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># Go decision: proceed to between-arm phase</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">n_add_selected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">viable_n</span><span class="op">)</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">n_max_between</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">n_enrolled</span> <span class="op">+</span> <span class="va">trial</span><span class="op">$</span><span class="va">n_add_selected</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">active_arms</span><span class="op">)</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">state</span> <span class="op">&lt;-</span> <span class="st">"STATE_BETWEEN"</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">pp_results</span><span class="op">$</span><span class="va">pp</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">pp_nogo</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># No-go decision: stop with single-arm conclusions</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">state</span> <span class="op">&lt;-</span> <span class="st">"STATE_STOP"</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">conclusion</span> <span class="op">&lt;-</span> <span class="st">"conversion_nogo"</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="co"># Ambiguous: could implement additional logic or default to no-go</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">state</span> <span class="op">&lt;-</span> <span class="st">"STATE_STOP"</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">conclusion</span> <span class="op">&lt;-</span> <span class="st">"conversion_ambiguous"</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="va">trial</span></span>
<span>    <span class="op">}</span>,</span>
<span>    </span>
<span>    <span class="st">"STATE_BETWEEN"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># Update posteriors</span></span>
<span>      <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/update_posteriors.html">update_posteriors</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Check between-arm efficacy</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">p_between</span> <span class="op">&gt;</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">gamma_between_eff</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">state</span> <span class="op">&lt;-</span> <span class="st">"STATE_STOP"</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">conclusion</span> <span class="op">&lt;-</span> <span class="st">"between_arm_efficacy"</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Check between-arm futility</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">p_between</span> <span class="op">&lt;</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">gamma_between_fut</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">state</span> <span class="op">&lt;-</span> <span class="st">"STATE_STOP"</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">conclusion</span> <span class="op">&lt;-</span> <span class="st">"between_arm_futility"</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Check max sample size</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">n_enrolled</span> <span class="op">&gt;=</span> <span class="va">trial</span><span class="op">$</span><span class="va">n_max_between</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">state</span> <span class="op">&lt;-</span> <span class="st">"STATE_STOP"</span></span>
<span>        <span class="va">trial</span><span class="op">$</span><span class="va">conclusion</span> <span class="op">&lt;-</span> <span class="st">"max_n_between_phase"</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      </span>
<span>      <span class="co"># Continue enrollment</span></span>
<span>      <span class="va">trial</span></span>
<span>    <span class="op">}</span>,</span>
<span>    </span>
<span>    <span class="st">"STATE_STOP"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># Terminal state - no transitions</span></span>
<span>      <span class="va">trial</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_5-predictive-probability-engine">5. Predictive Probability Engine<a class="anchor" aria-label="anchor" href="#id_5-predictive-probability-engine"></a></h2>
<div class="section level3">
<h3 id="id_51-core-algorithm">5.1 Core Algorithm<a class="anchor" aria-label="anchor" href="#id_51-core-algorithm"></a></h3>
<p>The predictive probability <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext mathvariant="normal">pred</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>N</mi><mtext mathvariant="normal">add</mtext></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\pi_{\text{pred}}(N_{\text{add}})</annotation></semantics></math> answers: “Given current data, if we enroll <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mtext mathvariant="normal">add</mtext></msub><annotation encoding="application/x-tex">N_{\text{add}}</annotation></semantics></math> additional patients per arm, what is the probability that the final between-arm comparison will meet the efficacy criterion?”</p>
<p><strong>Algorithm</strong>:</p>
<pre><code>Input:
  - Current posterior parameters: (a_A, b_A), (a_B, b_B)
  - Additional patients per arm: N_add
  - Accrual rate, follow-up time
  - Success criterion: γ_between_eff
  - Number of Monte Carlo samples: n_outer

Output:
  - π_pred: Predictive probability of success

Algorithm:
  success_count ← 0

  FOR i = 1 TO n_outer:
    # Step 1: Draw "true" hazards from current posterior
    λ_A^(i) ~ Gamma(a_A, b_A)
    λ_B^(i) ~ Gamma(a_B, b_B)

    # Step 2: Simulate future events and exposure under these "true" hazards
    (n_A^future, T_A^future) ← simulate_future(λ_A^(i), N_add, accrual, followup)
    (n_B^future, T_B^future) ← simulate_future(λ_B^(i), N_add, accrual, followup)

    # Step 3: Compute final posterior parameters (accumulate sufficient stats)
    a_A^final ← a_A + n_A^future
    b_A^final ← b_A + T_A^future
    a_B^final ← a_B + n_B^future
    b_B^final ← b_B + T_B^future

    # Step 4: Compute P(HR_AB &lt; 1 | final data) using closed form
    p_between^(i) ← F_F(b_A^final/b_B^final × a_B^final/a_A^final; 2a_A^final, 2a_B^final)

    # Step 5: Check success criterion
    IF p_between^(i) &gt; γ_between_eff THEN
      success_count ← success_count + 1

  RETURN success_count / n_outer</code></pre>
</div>
<div class="section level3">
<h3 id="id_52-simulating-future-events">5.2 Simulating Future Events<a class="anchor" aria-label="anchor" href="#id_52-simulating-future-events"></a></h3>
<p>For exponential survival with hazard <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>, accrual rate <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math> patients/month, and analysis at time <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math> after last patient enrolled:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulate_future_arm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lambda</span>, <span class="va">n_patients</span>, <span class="va">accrual_rate</span>, <span class="va">followup_months</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Enrollment times (uniform accrual)</span></span>
<span>  <span class="va">enrollment_duration</span> <span class="op">&lt;-</span> <span class="va">n_patients</span> <span class="op">/</span> <span class="va">accrual_rate</span></span>
<span>  <span class="va">enrollment_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_patients</span>, <span class="fl">0</span>, <span class="va">enrollment_duration</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Analysis time</span></span>
<span>  <span class="va">analysis_time</span> <span class="op">&lt;-</span> <span class="va">enrollment_duration</span> <span class="op">+</span> <span class="va">followup_months</span></span>
<span>  </span>
<span>  <span class="co"># Simulate survival times</span></span>
<span>  <span class="va">survival_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">n_patients</span>, rate <span class="op">=</span> <span class="va">lambda</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calendar time of event</span></span>
<span>  <span class="va">event_times</span> <span class="op">&lt;-</span> <span class="va">enrollment_times</span> <span class="op">+</span> <span class="va">survival_times</span></span>
<span>  </span>
<span>  <span class="co"># Observed time (censored at analysis)</span></span>
<span>  <span class="va">observed_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">survival_times</span>, <span class="va">analysis_time</span> <span class="op">-</span> <span class="va">enrollment_times</span><span class="op">)</span></span>
<span>  <span class="va">event_indicators</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">event_times</span> <span class="op">&lt;=</span> <span class="va">analysis_time</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Sufficient statistics</span></span>
<span>  <span class="va">n_events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">event_indicators</span><span class="op">)</span></span>
<span>  <span class="va">total_exposure</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">observed_times</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n_events <span class="op">=</span> <span class="va">n_events</span>,</span>
<span>    total_exposure <span class="op">=</span> <span class="va">total_exposure</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_53-complete-predictive-probability-function">5.3 Complete Predictive Probability Function<a class="anchor" aria-label="anchor" href="#id_53-complete-predictive-probability-function"></a></h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compute_pp_between_success</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">a_post</span>,                    <span class="co"># Named vector: c(A = ..., B = ...)</span></span>
<span>  <span class="va">b_post</span>,                    <span class="co"># Named vector: c(A = ..., B = ...)</span></span>
<span>  <span class="va">n_additional_per_arm</span>,      <span class="co"># Scalar or vector to evaluate</span></span>
<span>  <span class="va">accrual_rate</span>,              <span class="co"># Patients per month per arm</span></span>
<span>  <span class="va">followup_months</span>,           <span class="co"># Follow-up after last patient</span></span>
<span>  <span class="va">gamma_between_eff</span>,         <span class="co"># Success threshold (e.g., 0.975)</span></span>
<span>  <span class="va">n_outer</span> <span class="op">=</span> <span class="fl">1000</span>             <span class="co"># Monte Carlo samples</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Handle vector of candidate N values</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">n_additional_per_arm</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">n_additional_per_arm</span>, <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">compute_pp_between_success</span><span class="op">(</span></span>
<span>        <span class="va">a_post</span>, <span class="va">b_post</span>, <span class="va">n</span>, <span class="va">accrual_rate</span>, <span class="va">followup_months</span>, <span class="va">gamma_between_eff</span>, <span class="va">n_outer</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">success_count</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_outer</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># Step 1: Draw "true" hazards from current posterior</span></span>
<span>    <span class="va">lambda_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, shape <span class="op">=</span> <span class="va">a_post</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span>, rate <span class="op">=</span> <span class="va">b_post</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">lambda_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, shape <span class="op">=</span> <span class="va">a_post</span><span class="op">[</span><span class="st">"B"</span><span class="op">]</span>, rate <span class="op">=</span> <span class="va">b_post</span><span class="op">[</span><span class="st">"B"</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Step 2: Simulate future events and exposure</span></span>
<span>    <span class="va">fut_A</span> <span class="op">&lt;-</span> <span class="fu">simulate_future_arm</span><span class="op">(</span><span class="va">lambda_A</span>, <span class="va">n_additional_per_arm</span>, <span class="va">accrual_rate</span>, <span class="va">followup_months</span><span class="op">)</span></span>
<span>    <span class="va">fut_B</span> <span class="op">&lt;-</span> <span class="fu">simulate_future_arm</span><span class="op">(</span><span class="va">lambda_B</span>, <span class="va">n_additional_per_arm</span>, <span class="va">accrual_rate</span>, <span class="va">followup_months</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Step 3: Update posterior (accumulate sufficient stats)</span></span>
<span>    <span class="va">a_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      A <span class="op">=</span> <span class="va">a_post</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span> <span class="op">+</span> <span class="va">fut_A</span><span class="op">$</span><span class="va">n_events</span>,</span>
<span>      B <span class="op">=</span> <span class="va">a_post</span><span class="op">[</span><span class="st">"B"</span><span class="op">]</span> <span class="op">+</span> <span class="va">fut_B</span><span class="op">$</span><span class="va">n_events</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">b_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      A <span class="op">=</span> <span class="va">b_post</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span> <span class="op">+</span> <span class="va">fut_A</span><span class="op">$</span><span class="va">total_exposure</span>,</span>
<span>      B <span class="op">=</span> <span class="va">b_post</span><span class="op">[</span><span class="st">"B"</span><span class="op">]</span> <span class="op">+</span> <span class="va">fut_B</span><span class="op">$</span><span class="va">total_exposure</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Step 4: Compute P(HR_AB &lt; 1 | final data) - closed form</span></span>
<span>    <span class="va">p_between</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html" class="external-link">pf</a></span><span class="op">(</span></span>
<span>      q <span class="op">=</span> <span class="op">(</span><span class="va">b_final</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span> <span class="op">/</span> <span class="va">b_final</span><span class="op">[</span><span class="st">"B"</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">a_final</span><span class="op">[</span><span class="st">"B"</span><span class="op">]</span> <span class="op">/</span> <span class="va">a_final</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      df1 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_final</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span>,</span>
<span>      df2 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_final</span><span class="op">[</span><span class="st">"B"</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Step 5: Check success criterion</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">p_between</span> <span class="op">&gt;</span> <span class="va">gamma_between_eff</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">success_count</span> <span class="op">&lt;-</span> <span class="va">success_count</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">success_count</span> <span class="op">/</span> <span class="va">n_outer</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_54-finding-required-sample-size">5.4 Finding Required Sample Size<a class="anchor" aria-label="anchor" href="#id_54-finding-required-sample-size"></a></h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">find_n_for_target_pp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">a_post</span>, <span class="va">b_post</span>,</span>
<span>  <span class="va">target_pp</span>,                  <span class="co"># Target predictive probability (e.g., 0.80)</span></span>
<span>  <span class="va">accrual_rate</span>,</span>
<span>  <span class="va">followup_months</span>,</span>
<span>  <span class="va">gamma_between_eff</span>,</span>
<span>  <span class="va">n_range</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">200</span><span class="op">)</span>,       <span class="co"># Search range for N per arm</span></span>
<span>  <span class="va">tolerance</span> <span class="op">=</span> <span class="fl">5</span>,              <span class="co"># Tolerance for binary search</span></span>
<span>  <span class="va">n_outer</span> <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Binary search for minimum N achieving target PP</span></span>
<span>  <span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">n_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">n_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Check boundaries</span></span>
<span>  <span class="va">pp_lower</span> <span class="op">&lt;-</span> <span class="fu">compute_pp_between_success</span><span class="op">(</span></span>
<span>    <span class="va">a_post</span>, <span class="va">b_post</span>, <span class="va">lower</span>, <span class="va">accrual_rate</span>, <span class="va">followup_months</span>, <span class="va">gamma_between_eff</span>, <span class="va">n_outer</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">pp_upper</span> <span class="op">&lt;-</span> <span class="fu">compute_pp_between_success</span><span class="op">(</span></span>
<span>    <span class="va">a_post</span>, <span class="va">b_post</span>, <span class="va">upper</span>, <span class="va">accrual_rate</span>, <span class="va">followup_months</span>, <span class="va">gamma_between_eff</span>, <span class="va">n_outer</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">pp_lower</span> <span class="op">&gt;=</span> <span class="va">target_pp</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n_required <span class="op">=</span> <span class="va">lower</span>, pp_achieved <span class="op">=</span> <span class="va">pp_lower</span>, converged <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">pp_upper</span> <span class="op">&lt;</span> <span class="va">target_pp</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n_required <span class="op">=</span> <span class="cn">NA</span>, pp_achieved <span class="op">=</span> <span class="va">pp_upper</span>, converged <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                message <span class="op">=</span> <span class="st">"Target PP not achievable within range"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Binary search</span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="op">(</span><span class="va">upper</span> <span class="op">-</span> <span class="va">lower</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">tolerance</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="op">(</span><span class="va">lower</span> <span class="op">+</span> <span class="va">upper</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">pp_mid</span> <span class="op">&lt;-</span> <span class="fu">compute_pp_between_success</span><span class="op">(</span></span>
<span>      <span class="va">a_post</span>, <span class="va">b_post</span>, <span class="va">mid</span>, <span class="va">accrual_rate</span>, <span class="va">followup_months</span>, <span class="va">gamma_between_eff</span>, <span class="va">n_outer</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">pp_mid</span> <span class="op">&gt;=</span> <span class="va">target_pp</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">mid</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">mid</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n_required <span class="op">=</span> <span class="va">upper</span>,</span>
<span>    pp_achieved <span class="op">=</span> <span class="fu">compute_pp_between_success</span><span class="op">(</span></span>
<span>      <span class="va">a_post</span>, <span class="va">b_post</span>, <span class="va">upper</span>, <span class="va">accrual_rate</span>, <span class="va">followup_months</span>, <span class="va">gamma_between_eff</span>, <span class="va">n_outer</span> <span class="op">*</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span>,</span>
<span>    converged <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_55-computing-the-full-pp-curve">5.5 Computing the Full PP Curve<a class="anchor" aria-label="anchor" href="#id_55-computing-the-full-pp-curve"></a></h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compute_pp_curve</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Extract current posterior parameters</span></span>
<span>  <span class="va">a_post</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">a</span></span>
<span>  <span class="va">b_post</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">b</span></span>
<span>  </span>
<span>  <span class="co"># Candidate additional sample sizes</span></span>
<span>  <span class="va">n_candidates</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">conversion</span><span class="op">$</span><span class="va">n_max_candidates</span></span>
<span>  </span>
<span>  <span class="co"># Compute PP for each candidate</span></span>
<span>  <span class="va">pp_values</span> <span class="op">&lt;-</span> <span class="fu">compute_pp_between_success</span><span class="op">(</span></span>
<span>    a_post <span class="op">=</span> <span class="va">a_post</span>,</span>
<span>    b_post <span class="op">=</span> <span class="va">b_post</span>,</span>
<span>    n_additional_per_arm <span class="op">=</span> <span class="va">n_candidates</span>,</span>
<span>    accrual_rate <span class="op">=</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">accrual_rate</span>,</span>
<span>    followup_months <span class="op">=</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">followup_months</span>,</span>
<span>    gamma_between_eff <span class="op">=</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">between_arm_criteria</span><span class="op">$</span><span class="va">eff_prob</span>,</span>
<span>    n_outer <span class="op">=</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">conversion</span><span class="op">$</span><span class="va">n_outer_pp</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    n_add <span class="op">=</span> <span class="va">n_candidates</span>,</span>
<span>    pp <span class="op">=</span> <span class="va">pp_values</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_6-software-architecture">6. Software Architecture<a class="anchor" aria-label="anchor" href="#id_6-software-architecture"></a></h2>
<div class="section level3">
<h3 id="id_61-package-structure">6.1 Package Structure<a class="anchor" aria-label="anchor" href="#id_61-package-structure"></a></h3>
<pre><code>evolveTrial/
├── R/
│   ├── hybrid_design.R           # Design specification
│   ├── hybrid_trial.R            # Trial state and simulation
│   ├── hybrid_posterior.R        # Posterior computations (closed-form)
│   ├── hybrid_decisions.R        # Decision rule implementations
│   ├── hybrid_predictive.R       # Predictive probability engine
│   ├── hybrid_simulate.R         # Monte Carlo simulation wrapper
│   ├── hybrid_summary.R          # Operating characteristics summary
│   ├── single_arm_trial.R        # Existing (minimal changes)
│   ├── multiarm_trial.R          # Existing (minimal changes)
│   └── utils.R                   # Shared utilities
├── tests/
│   ├── test_hybrid_posterior.R   # Unit tests for posterior computations
│   ├── test_hybrid_decisions.R   # Unit tests for decision rules
│   ├── test_hybrid_predictive.R  # Unit tests for PP engine
│   ├── test_hybrid_simulate.R    # Integration tests
│   └── test_hybrid_edge_cases.R  # Edge case tests
├── vignettes/
│   └── hybrid_design_workflow.Rmd
└── man/
    └── ...</code></pre>
</div>
<div class="section level3">
<h3 id="id_62-core-s3-classes">6.2 Core S3 Classes<a class="anchor" aria-label="anchor" href="#id_62-core-s3-classes"></a></h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># =============================================================================</span></span>
<span><span class="co"># DESIGN SPECIFICATION CLASS</span></span>
<span><span class="co"># =============================================================================</span></span>
<span></span>
<span><span class="co">#' Create a Hybrid Single-to-Between Arm Survival Design</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param arms Character vector of arm names</span></span>
<span><span class="co">#' @param hist_median_surv Named numeric vector of historical median survival (months)</span></span>
<span><span class="co">#' @param single_arm_criteria List with hr_threshold, eff_prob, fut_prob</span></span>
<span><span class="co">#' @param between_arm_criteria List with eff_prob, fut_prob</span></span>
<span><span class="co">#' @param conversion List with trigger, pp_go, pp_nogo, n_max_candidates, etc.</span></span>
<span><span class="co">#' @param constraints List with n_max_total, max_duration_months, etc.</span></span>
<span><span class="co">#' @param interims List with timing, events_per_interim, etc.</span></span>
<span><span class="co">#' @param randomization List with scheme, initial_equal_n</span></span>
<span><span class="co">#' @param prior List with a0, b0 (gamma prior parameters)</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @return Object of class "hybrid_surv_design"</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">create_hybrid_surv_design</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">arms</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">hist_median_surv</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">12</span>, B <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">single_arm_criteria</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    hr_threshold <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>    eff_prob <span class="op">=</span> <span class="fl">0.90</span>,</span>
<span>    fut_prob <span class="op">=</span> <span class="fl">0.10</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">between_arm_criteria</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    eff_prob <span class="op">=</span> <span class="fl">0.975</span>,</span>
<span>    fut_prob <span class="op">=</span> <span class="fl">0.05</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">conversion</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    trigger <span class="op">=</span> <span class="st">"any_single_success"</span>,</span>
<span>    pp_go <span class="op">=</span> <span class="fl">0.70</span>,</span>
<span>    pp_nogo <span class="op">=</span> <span class="fl">0.20</span>,</span>
<span>    n_max_candidates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    n_outer_pp <span class="op">=</span> <span class="fl">1000</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">constraints</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n_max_total <span class="op">=</span> <span class="fl">200</span>,</span>
<span>    n_max_single_phase <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    max_duration_months <span class="op">=</span> <span class="fl">48</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">interims</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    timing <span class="op">=</span> <span class="st">"event_driven"</span>,</span>
<span>    events_per_interim <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    max_interims <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">randomization</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    scheme <span class="op">=</span> <span class="st">"equal"</span>,</span>
<span>    initial_equal_n <span class="op">=</span> <span class="fl">20</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">prior</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    a0 <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>    b0 <span class="op">=</span> <span class="fl">0.001</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">accrual_rate</span> <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  <span class="va">followup_months</span> <span class="op">=</span> <span class="fl">12</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span></span>
<span>  <span class="co"># Validate inputs</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">arms</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">arms</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hist_median_surv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">hr_threshold</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">hr_threshold</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="va">conversion</span><span class="op">$</span><span class="va">trigger</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"any_single_success"</span>, <span class="st">"all_single_success"</span>, <span class="st">"k_of_K"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Compute historical hazards from median survival</span></span>
<span>  <span class="va">hist_hazard</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="va">hist_median_surv</span><span class="op">[</span><span class="va">arms</span><span class="op">]</span>, <span class="va">arms</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Construct design object</span></span>
<span>  <span class="va">design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    arms <span class="op">=</span> <span class="va">arms</span>,</span>
<span>    K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">arms</span><span class="op">)</span>,</span>
<span>    hist_median_surv <span class="op">=</span> <span class="va">hist_median_surv</span><span class="op">[</span><span class="va">arms</span><span class="op">]</span>,</span>
<span>    hist_hazard <span class="op">=</span> <span class="va">hist_hazard</span>,</span>
<span>    single_arm_criteria <span class="op">=</span> <span class="va">single_arm_criteria</span>,</span>
<span>    between_arm_criteria <span class="op">=</span> <span class="va">between_arm_criteria</span>,</span>
<span>    conversion <span class="op">=</span> <span class="va">conversion</span>,</span>
<span>    constraints <span class="op">=</span> <span class="va">constraints</span>,</span>
<span>    interims <span class="op">=</span> <span class="va">interims</span>,</span>
<span>    randomization <span class="op">=</span> <span class="va">randomization</span>,</span>
<span>    prior <span class="op">=</span> <span class="va">prior</span>,</span>
<span>    accrual_rate <span class="op">=</span> <span class="va">accrual_rate</span>,</span>
<span>    followup_months <span class="op">=</span> <span class="va">followup_months</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hybrid_surv_design"</span>, <span class="st">"list"</span><span class="op">)</span></span>
<span>  <span class="va">design</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Print method</span></span>
<span><span class="va">print.hybrid_surv_design</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Hybrid Single-to-Between Arm Survival Design\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"=============================================\n\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Arms:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">arms</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Historical median survival:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">hist_median_surv</span>, <span class="st">"months"</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Single-arm criteria:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  HR threshold:"</span>, <span class="va">x</span><span class="op">$</span><span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">hr_threshold</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Efficacy prob:"</span>, <span class="va">x</span><span class="op">$</span><span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">eff_prob</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Futility prob:"</span>, <span class="va">x</span><span class="op">$</span><span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">fut_prob</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Between-arm criteria:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Efficacy prob:"</span>, <span class="va">x</span><span class="op">$</span><span class="va">between_arm_criteria</span><span class="op">$</span><span class="va">eff_prob</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Futility prob:"</span>, <span class="va">x</span><span class="op">$</span><span class="va">between_arm_criteria</span><span class="op">$</span><span class="va">fut_prob</span>, <span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Conversion:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Trigger:"</span>, <span class="va">x</span><span class="op">$</span><span class="va">conversion</span><span class="op">$</span><span class="va">trigger</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  PP go threshold:"</span>, <span class="va">x</span><span class="op">$</span><span class="va">conversion</span><span class="op">$</span><span class="va">pp_go</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  PP no-go threshold:"</span>, <span class="va">x</span><span class="op">$</span><span class="va">conversion</span><span class="op">$</span><span class="va">pp_nogo</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># =============================================================================</span></span>
<span><span class="co"># TRIAL STATE CLASS</span></span>
<span><span class="co"># =============================================================================</span></span>
<span></span>
<span><span class="co">#' Initialize a Hybrid Trial</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param design Object of class "hybrid_surv_design"</span></span>
<span><span class="co">#' @return Object of class "hybrid_trial"</span></span>
<span><span class="va">initialize_hybrid_trial</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">design</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    design <span class="op">=</span> <span class="va">design</span>,</span>
<span>    state <span class="op">=</span> <span class="st">"STATE_SINGLE"</span>,</span>
<span>    </span>
<span>    <span class="co"># Data</span></span>
<span>    patients <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      arm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      enrollment_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      event_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      observed_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      event <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    n_enrolled <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0L</span>, <span class="va">design</span><span class="op">$</span><span class="va">K</span><span class="op">)</span>, <span class="va">design</span><span class="op">$</span><span class="va">arms</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># Sufficient statistics for posterior</span></span>
<span>    posterior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">design</span><span class="op">$</span><span class="va">prior</span><span class="op">$</span><span class="va">a0</span>, <span class="va">design</span><span class="op">$</span><span class="va">K</span><span class="op">)</span>, <span class="va">design</span><span class="op">$</span><span class="va">arms</span><span class="op">)</span>,</span>
<span>      b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">design</span><span class="op">$</span><span class="va">prior</span><span class="op">$</span><span class="va">b0</span>, <span class="va">design</span><span class="op">$</span><span class="va">K</span><span class="op">)</span>, <span class="va">design</span><span class="op">$</span><span class="va">arms</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># Current probabilities</span></span>
<span>    p_single <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA_real_</span>, <span class="va">design</span><span class="op">$</span><span class="va">K</span><span class="op">)</span>, <span class="va">design</span><span class="op">$</span><span class="va">arms</span><span class="op">)</span>,</span>
<span>    p_between <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>    </span>
<span>    <span class="co"># Arm status</span></span>
<span>    active_arms <span class="op">=</span> <span class="va">design</span><span class="op">$</span><span class="va">arms</span>,</span>
<span>    dropped_arms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    successful_arms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,  <span class="co"># Single-arm efficacy achieved</span></span>
<span>    </span>
<span>    <span class="co"># Conversion info</span></span>
<span>    conversion_triggered <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    n_add_selected <span class="op">=</span> <span class="cn">NA_integer_</span>,</span>
<span>    n_max_between <span class="op">=</span> <span class="cn">NA_integer_</span>,</span>
<span>    pp_at_conversion <span class="op">=</span> <span class="cn">NA_real_</span>,</span>
<span>    </span>
<span>    <span class="co"># Timeline</span></span>
<span>    current_time <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    interim_count <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    </span>
<span>    <span class="co"># Final conclusions</span></span>
<span>    conclusion <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    final_p_single <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    final_p_between <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hybrid_trial"</span>, <span class="st">"list"</span><span class="op">)</span></span>
<span>  <span class="va">trial</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_63-core-functions">6.3 Core Functions<a class="anchor" aria-label="anchor" href="#id_63-core-functions"></a></h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># =============================================================================</span></span>
<span><span class="co"># POSTERIOR COMPUTATIONS</span></span>
<span><span class="co"># =============================================================================</span></span>
<span></span>
<span><span class="co">#' Update Posterior Parameters from Trial Data</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param trial Object of class "hybrid_trial"</span></span>
<span><span class="co">#' @param analysis_time Time at which to compute posterior (for censoring)</span></span>
<span><span class="co">#' @return Updated trial object</span></span>
<span><span class="va">update_posteriors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">analysis_time</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">analysis_time</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">analysis_time</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">current_time</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">arms</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Get patients in this arm</span></span>
<span>    <span class="va">arm_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">patients</span><span class="op">[</span><span class="va">trial</span><span class="op">$</span><span class="va">patients</span><span class="op">$</span><span class="va">arm</span> <span class="op">==</span> <span class="va">k</span>, <span class="op">]</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">arm_data</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">prior</span><span class="op">$</span><span class="va">a0</span></span>
<span>      <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">b</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">prior</span><span class="op">$</span><span class="va">b0</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># Compute observed times (censored at analysis_time)</span></span>
<span>      <span class="va">time_on_study</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span></span>
<span>        <span class="va">arm_data</span><span class="op">$</span><span class="va">event_time</span> <span class="op">-</span> <span class="va">arm_data</span><span class="op">$</span><span class="va">enrollment_time</span>,</span>
<span>        <span class="va">analysis_time</span> <span class="op">-</span> <span class="va">arm_data</span><span class="op">$</span><span class="va">enrollment_time</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="va">time_on_study</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">time_on_study</span>, <span class="fl">0</span><span class="op">)</span>  <span class="co"># Ensure non-negative</span></span>
<span>      </span>
<span>      <span class="va">events</span> <span class="op">&lt;-</span> <span class="va">arm_data</span><span class="op">$</span><span class="va">event</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">arm_data</span><span class="op">$</span><span class="va">event_time</span> <span class="op">&lt;=</span> <span class="va">analysis_time</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="co"># Update sufficient statistics</span></span>
<span>      <span class="va">n_events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">events</span><span class="op">)</span></span>
<span>      <span class="va">total_exposure</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">time_on_study</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">prior</span><span class="op">$</span><span class="va">a0</span> <span class="op">+</span> <span class="va">n_events</span></span>
<span>      <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">b</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">prior</span><span class="op">$</span><span class="va">b0</span> <span class="op">+</span> <span class="va">total_exposure</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Compute decision quantities</span></span>
<span>  <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu">compute_decision_quantities</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">trial</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Compute Decision Quantities (Single-arm and Between-arm Probabilities)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param trial Object of class "hybrid_trial"</span></span>
<span><span class="co">#' @return Updated trial object with p_single and p_between</span></span>
<span><span class="va">compute_decision_quantities</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Single-arm probabilities: P(HR_k^hist &lt; c_k | data)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">arms</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">c_k</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">hr_threshold</span></span>
<span>    <span class="va">lambda_hist_k</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">hist_hazard</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># Threshold on lambda scale</span></span>
<span>    <span class="va">lambda_threshold</span> <span class="op">&lt;-</span> <span class="va">c_k</span> <span class="op">*</span> <span class="va">lambda_hist_k</span></span>
<span>    </span>
<span>    <span class="co"># P(lambda_k &lt; threshold) = Gamma CDF</span></span>
<span>    <span class="va">trial</span><span class="op">$</span><span class="va">p_single</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">pgamma</a></span><span class="op">(</span></span>
<span>      q <span class="op">=</span> <span class="va">lambda_threshold</span>,</span>
<span>      shape <span class="op">=</span> <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">k</span><span class="op">]</span>,</span>
<span>      rate <span class="op">=</span> <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">b</span><span class="op">[</span><span class="va">k</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Between-arm probability (for two-arm case: P(HR_AB &lt; 1))</span></span>
<span>  <span class="co"># For K &gt; 2, could compute pairwise or vs "best"</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">K</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">arms</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">arms</span></span>
<span>    <span class="va">a_A</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">arms</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">b_A</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">b</span><span class="op">[</span><span class="va">arms</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">a_B</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">arms</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">b_B</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">b</span><span class="op">[</span><span class="va">arms</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># P(lambda_A / lambda_B &lt; 1) using F distribution</span></span>
<span>    <span class="va">trial</span><span class="op">$</span><span class="va">p_between</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html" class="external-link">pf</a></span><span class="op">(</span></span>
<span>      q <span class="op">=</span> <span class="op">(</span><span class="va">b_A</span> <span class="op">/</span> <span class="va">b_B</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">a_B</span> <span class="op">/</span> <span class="va">a_A</span><span class="op">)</span>,</span>
<span>      df1 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_A</span>,</span>
<span>      df2 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_B</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># For K &gt; 2, implement pairwise or other comparison strategy</span></span>
<span>    <span class="co"># Placeholder: compare first arm vs pooled others, or implement max comparison</span></span>
<span>    <span class="va">trial</span><span class="op">$</span><span class="va">p_between</span> <span class="op">&lt;-</span> <span class="cn">NA_real_</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">trial</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># =============================================================================</span></span>
<span><span class="co"># DECISION RULES</span></span>
<span><span class="co"># =============================================================================</span></span>
<span></span>
<span><span class="co">#' Check Single-Arm Efficacy for an Arm</span></span>
<span><span class="co">#' @return Logical</span></span>
<span><span class="va">check_single_arm_efficacy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">arm</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">p_single</span><span class="op">[</span><span class="va">arm</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">eff_prob</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Check Single-Arm Futility for an Arm</span></span>
<span><span class="co">#' @return Logical</span></span>
<span><span class="va">check_single_arm_futility</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">arm</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">p_single</span><span class="op">[</span><span class="va">arm</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">fut_prob</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Check Between-Arm Efficacy</span></span>
<span><span class="co">#' @return Logical</span></span>
<span><span class="va">check_between_arm_efficacy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">p_between</span> <span class="op">&gt;</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">between_arm_criteria</span><span class="op">$</span><span class="va">eff_prob</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Check Between-Arm Futility</span></span>
<span><span class="co">#' @return Logical</span></span>
<span><span class="va">check_between_arm_futility</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">p_between</span> <span class="op">&lt;</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">between_arm_criteria</span><span class="op">$</span><span class="va">fut_prob</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Check Transition Trigger</span></span>
<span><span class="co">#' @return Logical</span></span>
<span><span class="va">check_transition_trigger</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trigger</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">conversion</span><span class="op">$</span><span class="va">trigger</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">trigger</span>,</span>
<span>    <span class="st">"any_single_success"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">active_arms</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="fu">check_single_arm_efficacy</span><span class="op">(</span><span class="va">trial</span>, <span class="va">k</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="st">"all_single_success"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">active_arms</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="fu">check_single_arm_efficacy</span><span class="op">(</span><span class="va">trial</span>, <span class="va">k</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="st">"k_of_K"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">k_required</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">conversion</span><span class="op">$</span><span class="va">k_required</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">active_arms</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="fu">check_single_arm_efficacy</span><span class="op">(</span><span class="va">trial</span>, <span class="va">k</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">k_required</span></span>
<span>    <span class="op">}</span>,</span>
<span>    <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Drop an Arm</span></span>
<span><span class="co">#' @return Updated trial object</span></span>
<span><span class="va">drop_arm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">arm</span>, <span class="va">reason</span> <span class="op">=</span> <span class="st">"futility"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">active_arms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">active_arms</span>, <span class="va">arm</span><span class="op">)</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">dropped_arms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">dropped_arms</span>, <span class="va">arm</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">dropped_arms</span>, <span class="st">"reasons"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">dropped_arms</span>, <span class="st">"reasons"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">reason</span>, <span class="va">arm</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">trial</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_64-simulation-engine">6.4 Simulation Engine<a class="anchor" aria-label="anchor" href="#id_64-simulation-engine"></a></h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># =============================================================================</span></span>
<span><span class="co"># SINGLE TRIAL SIMULATION</span></span>
<span><span class="co"># =============================================================================</span></span>
<span></span>
<span><span class="co">#' Simulate a Single Hybrid Trial</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param design Object of class "hybrid_surv_design"</span></span>
<span><span class="co">#' @param scenario List with true_hazard (named vector) and other simulation params</span></span>
<span><span class="co">#' @param seed Random seed</span></span>
<span><span class="co">#' @return Object of class "hybrid_trial" with complete trajectory</span></span>
<span><span class="va">simulate_hybrid_trial</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">design</span>, <span class="va">scenario</span>, <span class="va">seed</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Initialize trial</span></span>
<span>  <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu">initialize_hybrid_trial</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Run until terminal state</span></span>
<span> <span class="kw">while</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">state</span> <span class="op">!=</span> <span class="st">"STATE_STOP"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="co"># Enroll patients until next interim</span></span>
<span>    <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu">enroll_patients_until_interim</span><span class="op">(</span><span class="va">trial</span>, <span class="va">scenario</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Update posteriors at interim</span></span>
<span>    <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/update_posteriors.html">update_posteriors</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>    <span class="va">trial</span><span class="op">$</span><span class="va">interim_count</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">interim_count</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    </span>
<span>    <span class="co"># Apply state-specific logic and transitions</span></span>
<span>    <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu">update_trial_state</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Finalize</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">final_p_single</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">p_single</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">final_p_between</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">p_between</span></span>
<span>  </span>
<span>  <span class="va">trial</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Enroll Patients Until Next Interim Analysis</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param trial Object of class "hybrid_trial"</span></span>
<span><span class="co">#' @param scenario Simulation scenario with true hazards</span></span>
<span><span class="co">#' @return Updated trial object</span></span>
<span><span class="va">enroll_patients_until_interim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">scenario</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Determine target for next interim</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">interims</span><span class="op">$</span><span class="va">timing</span> <span class="op">==</span> <span class="st">"event_driven"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Enroll until we have enough events</span></span>
<span>    <span class="va">target_events</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">interims</span><span class="op">$</span><span class="va">events_per_interim</span> <span class="op">*</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">interim_count</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">while</span> <span class="op">(</span><span class="fu">count_events</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">target_events</span> <span class="op">&amp;&amp;</span> </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">n_enrolled</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">constraints</span><span class="op">$</span><span class="va">n_max_total</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu">enroll_one_patient</span><span class="op">(</span><span class="va">trial</span>, <span class="va">scenario</span><span class="op">)</span></span>
<span>      <span class="va">trial</span><span class="op">$</span><span class="va">current_time</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">current_time</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">accrual_rate</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">interims</span><span class="op">$</span><span class="va">timing</span> <span class="op">==</span> <span class="st">"calendar"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Enroll until calendar time</span></span>
<span>    <span class="va">target_time</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">interims</span><span class="op">$</span><span class="va">months_per_interim</span> <span class="op">*</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">interim_count</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">while</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">current_time</span> <span class="op">&lt;</span> <span class="va">target_time</span> <span class="op">&amp;&amp;</span> </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">n_enrolled</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">constraints</span><span class="op">$</span><span class="va">n_max_total</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu">enroll_one_patient</span><span class="op">(</span><span class="va">trial</span>, <span class="va">scenario</span><span class="op">)</span></span>
<span>      <span class="va">trial</span><span class="op">$</span><span class="va">current_time</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">current_time</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">accrual_rate</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">trial</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Enroll One Patient</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param trial Object of class "hybrid_trial"</span></span>
<span><span class="co">#' @param scenario Simulation scenario</span></span>
<span><span class="co">#' @return Updated trial object</span></span>
<span><span class="va">enroll_one_patient</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">scenario</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Randomize to an active arm</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">design</span><span class="op">$</span><span class="va">randomization</span><span class="op">$</span><span class="va">scheme</span> <span class="op">==</span> <span class="st">"equal"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">arm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">active_arms</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Implement RAR if needed</span></span>
<span>    <span class="va">arm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">active_arms</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Generate survival time under true hazard</span></span>
<span>  <span class="va">true_hazard</span> <span class="op">&lt;-</span> <span class="va">scenario</span><span class="op">$</span><span class="va">true_hazard</span><span class="op">[</span><span class="va">arm</span><span class="op">]</span></span>
<span>  <span class="va">survival_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="fl">1</span>, rate <span class="op">=</span> <span class="va">true_hazard</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create patient record</span></span>
<span>  <span class="va">new_patient</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">patients</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>    arm <span class="op">=</span> <span class="va">arm</span>,</span>
<span>    enrollment_time <span class="op">=</span> <span class="va">trial</span><span class="op">$</span><span class="va">current_time</span>,</span>
<span>    event_time <span class="op">=</span> <span class="va">trial</span><span class="op">$</span><span class="va">current_time</span> <span class="op">+</span> <span class="va">survival_time</span>,</span>
<span>    observed_time <span class="op">=</span> <span class="cn">NA</span>,  <span class="co"># Will be computed at analysis</span></span>
<span>    event <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># Will be updated for censoring</span></span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">patients</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">patients</span>, <span class="va">new_patient</span><span class="op">)</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">n_enrolled</span><span class="op">[</span><span class="va">arm</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="va">n_enrolled</span><span class="op">[</span><span class="va">arm</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="va">trial</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Count Total Events Observed by Current Time</span></span>
<span><span class="va">count_events</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">patients</span><span class="op">$</span><span class="va">event_time</span> <span class="op">&lt;=</span> <span class="va">trial</span><span class="op">$</span><span class="va">current_time</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># =============================================================================</span></span>
<span><span class="co"># MULTIPLE TRIAL SIMULATION</span></span>
<span><span class="co"># =============================================================================</span></span>
<span></span>
<span><span class="co">#' Simulate Multiple Hybrid Trials and Compute Operating Characteristics</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param design Object of class "hybrid_surv_design"</span></span>
<span><span class="co">#' @param scenario Simulation scenario</span></span>
<span><span class="co">#' @param n_sims Number of simulations</span></span>
<span><span class="co">#' @param parallel Logical, use parallel processing</span></span>
<span><span class="co">#' @param n_cores Number of cores (NULL for auto-detect)</span></span>
<span><span class="co">#' @return Object of class "hybrid_sim_results"</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">simulate_hybrid_trials</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">design</span>,</span>
<span>  <span class="va">scenario</span>,</span>
<span>  <span class="va">n_sims</span> <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  <span class="va">parallel</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">n_cores</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">parallel</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Export required objects</span></span>
<span>    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"design"</span>, <span class="st">"scenario"</span><span class="op">)</span>, envir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span><span class="va">cl</span>, <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">evolveTrial</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_sims</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">simulate_hybrid_trial</span><span class="op">(</span><span class="va">design</span>, <span class="va">scenario</span>, seed <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_sims</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">simulate_hybrid_trial</span><span class="op">(</span><span class="va">design</span>, <span class="va">scenario</span>, seed <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Compile operating characteristics</span></span>
<span>  <span class="va">ocs</span> <span class="op">&lt;-</span> <span class="fu">compile_operating_characteristics</span><span class="op">(</span><span class="va">results</span>, <span class="va">design</span>, <span class="va">scenario</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      design <span class="op">=</span> <span class="va">design</span>,</span>
<span>      scenario <span class="op">=</span> <span class="va">scenario</span>,</span>
<span>      n_sims <span class="op">=</span> <span class="va">n_sims</span>,</span>
<span>      trials <span class="op">=</span> <span class="va">results</span>,</span>
<span>      ocs <span class="op">=</span> <span class="va">ocs</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hybrid_sim_results"</span>, <span class="st">"list"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Compile Operating Characteristics from Simulation Results</span></span>
<span><span class="va">compile_operating_characteristics</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">results</span>, <span class="va">design</span>, <span class="va">scenario</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract outcomes</span></span>
<span>  <span class="va">conclusions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">conclusion</span><span class="op">)</span></span>
<span>  <span class="va">states_reached</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">conversion_triggered</span><span class="op">)</span></span>
<span>  <span class="va">n_enrolled_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">n_enrolled</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">n_interims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">interim_count</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Single-arm outcomes</span></span>
<span>  <span class="va">single_arm_efficacy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">design</span><span class="op">$</span><span class="va">arms</span>, <span class="kw">function</span><span class="op">(</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">k</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">x</span><span class="op">$</span><span class="va">successful_arms</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Between-arm outcomes</span></span>
<span>  <span class="va">reached_between</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">states_reached</span><span class="op">)</span></span>
<span>  <span class="va">between_efficacy_given_reached</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span><span class="op">[</span><span class="va">states_reached</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">x</span><span class="op">$</span><span class="va">conclusion</span> <span class="op">==</span> <span class="st">"between_arm_efficacy"</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">between_efficacy_overall</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">conclusions</span> <span class="op">==</span> <span class="st">"between_arm_efficacy"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Type I error (depends on scenario)</span></span>
<span>  <span class="co"># If scenario is null (HR = 1), then between_efficacy is type I error</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># Sample size</span></span>
<span>    mean_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">n_enrolled_total</span><span class="op">)</span>,</span>
<span>    sd_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">n_enrolled_total</span><span class="op">)</span>,</span>
<span>    median_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">n_enrolled_total</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># Single-arm</span></span>
<span>    prob_single_arm_efficacy <span class="op">=</span> <span class="va">single_arm_efficacy</span>,</span>
<span>    </span>
<span>    <span class="co"># Conversion</span></span>
<span>    prob_conversion <span class="op">=</span> <span class="va">reached_between</span>,</span>
<span>    mean_n_at_conversion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span><span class="op">[</span><span class="va">states_reached</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">n_enrolled</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># Between-arm</span></span>
<span>    prob_between_efficacy_given_conversion <span class="op">=</span> <span class="va">between_efficacy_given_reached</span>,</span>
<span>    prob_between_efficacy_overall <span class="op">=</span> <span class="va">between_efficacy_overall</span>,</span>
<span>    </span>
<span>    <span class="co"># By conclusion</span></span>
<span>    conclusion_table <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">conclusions</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_sims</span>,</span>
<span>    </span>
<span>    <span class="co"># Duration</span></span>
<span>    mean_interims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">n_interims</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_7-baton-calibration">7. BATON Calibration<a class="anchor" aria-label="anchor" href="#id_7-baton-calibration"></a></h2>
<div class="section level3">
<h3 id="id_71-design-parameter-vector-φ">7.1 Design Parameter Vector (φ)<a class="anchor" aria-label="anchor" href="#id_71-design-parameter-vector-%CF%86"></a></h3>
<p>The parameters to be optimized by BATON:</p>
<table class="table"><colgroup><col width="28%"><col width="20%"><col width="17%"><col width="33%"></colgroup><thead><tr class="header"><th>Parameter</th>
<th>Symbol</th>
<th>Range</th>
<th>Description</th>
</tr></thead><tbody><tr class="odd"><td>Single-arm efficacy threshold</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>γ</mi><mtext mathvariant="normal">eff</mtext><mtext mathvariant="normal">single</mtext></msubsup><annotation encoding="application/x-tex">\gamma_{\text{eff}}^{\text{single}}</annotation></semantics></math></td>
<td>[0.80, 0.99]</td>
<td>Posterior prob for single-arm efficacy</td>
</tr><tr class="even"><td>Single-arm futility threshold</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>γ</mi><mtext mathvariant="normal">fut</mtext><mtext mathvariant="normal">single</mtext></msubsup><annotation encoding="application/x-tex">\gamma_{\text{fut}}^{\text{single}}</annotation></semantics></math></td>
<td>[0.01, 0.20]</td>
<td>Posterior prob for single-arm futility</td>
</tr><tr class="odd"><td>HR threshold vs historical</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>c</mi><annotation encoding="application/x-tex">c</annotation></semantics></math></td>
<td>[0.60, 0.90]</td>
<td>Target HR improvement</td>
</tr><tr class="even"><td>Between-arm efficacy threshold</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>γ</mi><mtext mathvariant="normal">eff</mtext><mtext mathvariant="normal">between</mtext></msubsup><annotation encoding="application/x-tex">\gamma_{\text{eff}}^{\text{between}}</annotation></semantics></math></td>
<td>[0.95, 0.999]</td>
<td>Posterior prob for between-arm efficacy</td>
</tr><tr class="odd"><td>Between-arm futility threshold</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>γ</mi><mtext mathvariant="normal">fut</mtext><mtext mathvariant="normal">between</mtext></msubsup><annotation encoding="application/x-tex">\gamma_{\text{fut}}^{\text{between}}</annotation></semantics></math></td>
<td>[0.01, 0.10]</td>
<td>Posterior prob for between-arm futility</td>
</tr><tr class="even"><td>Conversion go threshold</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>π</mi><mtext mathvariant="normal">go</mtext></msub><annotation encoding="application/x-tex">\pi_{\text{go}}</annotation></semantics></math></td>
<td>[0.50, 0.90]</td>
<td>PP threshold to proceed</td>
</tr><tr class="odd"><td>Conversion no-go threshold</td>
<td><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>π</mi><mtext mathvariant="normal">nogo</mtext></msub><annotation encoding="application/x-tex">\pi_{\text{nogo}}</annotation></semantics></math></td>
<td>[0.10, 0.40]</td>
<td>PP threshold to stop</td>
</tr></tbody></table><p><strong>Total dimensions</strong>: 7 continuous parameters</p>
</div>
<div class="section level3">
<h3 id="id_72-scenarios-for-calibration">7.2 Scenarios for Calibration<a class="anchor" aria-label="anchor" href="#id_72-scenarios-for-calibration"></a></h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Standard scenario set for calibration</span></span>
<span><span class="va">calibration_scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  </span>
<span>  <span class="co"># Null scenarios (for Type I error control)</span></span>
<span>  null_global <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"Global null"</span>,</span>
<span>    true_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.0578</span>, B <span class="op">=</span> <span class="fl">0.0578</span><span class="op">)</span>,  <span class="co"># Both equal to historical (12 mo median)</span></span>
<span>    true_hr_vs_hist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">1.0</span>, B <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span>,</span>
<span>    true_hr_between <span class="op">=</span> <span class="fl">1.0</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  null_between <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"Both beat historical, no between-arm difference"</span>,</span>
<span>    true_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.0462</span>, B <span class="op">=</span> <span class="fl">0.0462</span><span class="op">)</span>,  <span class="co"># Both 20% better than historical (15 mo median)</span></span>
<span>    true_hr_vs_hist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.8</span>, B <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>,</span>
<span>    true_hr_between <span class="op">=</span> <span class="fl">1.0</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Alternative scenarios (for power)</span></span>
<span>  alt_both_different <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"A better than B, both beat historical"</span>,</span>
<span>    true_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.0385</span>, B <span class="op">=</span> <span class="fl">0.0513</span><span class="op">)</span>,  <span class="co"># A: 18mo median, B: 13.5mo median</span></span>
<span>    true_hr_vs_hist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.67</span>, B <span class="op">=</span> <span class="fl">0.89</span><span class="op">)</span>,</span>
<span>    true_hr_between <span class="op">=</span> <span class="fl">0.75</span>  <span class="co"># A is 25% better than B</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  alt_strong_difference <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"Strong between-arm difference"</span>,</span>
<span>    true_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.0347</span>, B <span class="op">=</span> <span class="fl">0.0578</span><span class="op">)</span>,  <span class="co"># A: 20mo median, B: 12mo median</span></span>
<span>    true_hr_vs_hist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.6</span>, B <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span>,</span>
<span>    true_hr_between <span class="op">=</span> <span class="fl">0.6</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># Edge cases</span></span>
<span>  one_arm_futile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="st">"One arm futile"</span>,</span>
<span>    true_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.0385</span>, B <span class="op">=</span> <span class="fl">0.0694</span><span class="op">)</span>,  <span class="co"># A: 18mo, B: 10mo (worse than hist)</span></span>
<span>    true_hr_vs_hist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.67</span>, B <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span>,</span>
<span>    true_hr_between <span class="op">=</span> <span class="fl">0.55</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_73-objective-function">7.3 Objective Function<a class="anchor" aria-label="anchor" href="#id_73-objective-function"></a></h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' BATON Objective Function for Hybrid Design Calibration</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param phi Named vector of design parameters</span></span>
<span><span class="co">#' @param design_template Base design object</span></span>
<span><span class="co">#' @param scenarios List of calibration scenarios</span></span>
<span><span class="co">#' @param targets List of target operating characteristics</span></span>
<span><span class="co">#' @param n_sims Simulations per scenario</span></span>
<span><span class="co">#' @return List with objective value and constraint violations</span></span>
<span><span class="va">baton_objective</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">phi</span>,</span>
<span>  <span class="va">design_template</span>,</span>
<span>  <span class="va">scenarios</span>,</span>
<span>  <span class="va">targets</span>,</span>
<span>  <span class="va">n_sims</span> <span class="op">=</span> <span class="fl">5000</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Build design from phi</span></span>
<span>  <span class="va">design</span> <span class="op">&lt;-</span> <span class="fu">build_design_from_phi</span><span class="op">(</span><span class="va">design_template</span>, <span class="va">phi</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Evaluate across scenarios</span></span>
<span>  <span class="va">ocs_by_scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">scenarios</span>, <span class="kw">function</span><span class="op">(</span><span class="va">scen</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sim_results</span> <span class="op">&lt;-</span> <span class="fu">simulate_hybrid_trials</span><span class="op">(</span><span class="va">design</span>, <span class="va">scen</span>, n_sims <span class="op">=</span> <span class="va">n_sims</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">sim_results</span><span class="op">$</span><span class="va">ocs</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ocs_by_scenario</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Compute constraint violations</span></span>
<span>  <span class="va">constraints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Type I error for single-arm (under global null)</span></span>
<span>  <span class="va">constraints</span><span class="op">$</span><span class="va">single_type1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ocs_by_scenario</span><span class="op">$</span><span class="va">null_global</span><span class="op">$</span><span class="va">prob_single_arm_efficacy</span><span class="op">)</span> <span class="op">-</span> <span class="va">targets</span><span class="op">$</span><span class="va">single_type1_max</span></span>
<span>  </span>
<span>  <span class="co"># Type I error for between-arm (under null_between where single-arm might succeed)</span></span>
<span>  <span class="va">constraints</span><span class="op">$</span><span class="va">between_type1</span> <span class="op">&lt;-</span> <span class="va">ocs_by_scenario</span><span class="op">$</span><span class="va">null_between</span><span class="op">$</span><span class="va">prob_between_efficacy_overall</span> <span class="op">-</span> <span class="va">targets</span><span class="op">$</span><span class="va">between_type1_max</span></span>
<span>  </span>
<span>  <span class="co"># Power for single-arm (under alt_both_different)</span></span>
<span>  <span class="va">constraints</span><span class="op">$</span><span class="va">single_power</span> <span class="op">&lt;-</span> <span class="va">targets</span><span class="op">$</span><span class="va">single_power_min</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">ocs_by_scenario</span><span class="op">$</span><span class="va">alt_both_different</span><span class="op">$</span><span class="va">prob_single_arm_efficacy</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Power for between-arm (under alt_both_different)</span></span>
<span>  <span class="va">constraints</span><span class="op">$</span><span class="va">between_power</span> <span class="op">&lt;-</span> <span class="va">targets</span><span class="op">$</span><span class="va">between_power_min</span> <span class="op">-</span> <span class="va">ocs_by_scenario</span><span class="op">$</span><span class="va">alt_both_different</span><span class="op">$</span><span class="va">prob_between_efficacy_overall</span></span>
<span>  </span>
<span>  <span class="co"># Compute objective (minimize expected sample size, subject to constraints)</span></span>
<span>  <span class="co"># Weighted average across scenarios</span></span>
<span>  <span class="va">expected_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">ocs_by_scenario</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mean_n</span><span class="op">)</span>,</span>
<span>    w <span class="op">=</span> <span class="va">targets</span><span class="op">$</span><span class="va">scenario_weights</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Add penalty for unnecessary conversions under null_between</span></span>
<span>  <span class="va">conversion_penalty</span> <span class="op">&lt;-</span> <span class="va">ocs_by_scenario</span><span class="op">$</span><span class="va">null_between</span><span class="op">$</span><span class="va">prob_conversion</span> <span class="op">*</span> <span class="va">targets</span><span class="op">$</span><span class="va">conversion_penalty_weight</span></span>
<span>  </span>
<span>  <span class="va">objective_value</span> <span class="op">&lt;-</span> <span class="va">expected_n</span> <span class="op">+</span> <span class="va">conversion_penalty</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="va">objective_value</span>,</span>
<span>    constraints <span class="op">=</span> <span class="va">constraints</span>,</span>
<span>    feasible <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">constraints</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ocs <span class="op">=</span> <span class="va">ocs_by_scenario</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' Build Design Object from Parameter Vector</span></span>
<span><span class="va">build_design_from_phi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">design_template</span>, <span class="va">phi</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">design</span> <span class="op">&lt;-</span> <span class="va">design_template</span></span>
<span>  </span>
<span>  <span class="va">design</span><span class="op">$</span><span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">eff_prob</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span><span class="st">"gamma_single_eff"</span><span class="op">]</span></span>
<span>  <span class="va">design</span><span class="op">$</span><span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">fut_prob</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span><span class="st">"gamma_single_fut"</span><span class="op">]</span></span>
<span>  <span class="va">design</span><span class="op">$</span><span class="va">single_arm_criteria</span><span class="op">$</span><span class="va">hr_threshold</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span><span class="st">"hr_threshold"</span><span class="op">]</span></span>
<span>  <span class="va">design</span><span class="op">$</span><span class="va">between_arm_criteria</span><span class="op">$</span><span class="va">eff_prob</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span><span class="st">"gamma_between_eff"</span><span class="op">]</span></span>
<span>  <span class="va">design</span><span class="op">$</span><span class="va">between_arm_criteria</span><span class="op">$</span><span class="va">fut_prob</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span><span class="st">"gamma_between_fut"</span><span class="op">]</span></span>
<span>  <span class="va">design</span><span class="op">$</span><span class="va">conversion</span><span class="op">$</span><span class="va">pp_go</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span><span class="st">"pp_go"</span><span class="op">]</span></span>
<span>  <span class="va">design</span><span class="op">$</span><span class="va">conversion</span><span class="op">$</span><span class="va">pp_nogo</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span><span class="st">"pp_nogo"</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">design</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_74-calibration-wrapper">7.4 Calibration Wrapper<a class="anchor" aria-label="anchor" href="#id_74-calibration-wrapper"></a></h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Calibrate Hybrid Design Using BATON</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param design_template Base design object</span></span>
<span><span class="co">#' @param scenarios Calibration scenarios</span></span>
<span><span class="co">#' @param targets Target operating characteristics</span></span>
<span><span class="co">#' @param baton_config BATON configuration</span></span>
<span><span class="co">#' @return Calibration results</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">calibrate_hybrid_design</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">design_template</span>,</span>
<span>  </span>
<span>  <span class="va">scenarios</span> <span class="op">=</span> <span class="va">calibration_scenarios</span>,</span>
<span>  </span>
<span>  <span class="va">targets</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    single_type1_max <span class="op">=</span> <span class="fl">0.10</span>,</span>
<span>    between_type1_max <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>    single_power_min <span class="op">=</span> <span class="fl">0.80</span>,</span>
<span>    between_power_min <span class="op">=</span> <span class="fl">0.80</span>,</span>
<span>    scenario_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    conversion_penalty_weight <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="va">baton_config</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    n_initial <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    n_iterations <span class="op">=</span> <span class="fl">150</span>,</span>
<span>    n_sims_per_design <span class="op">=</span> <span class="fl">3000</span>,</span>
<span>    n_validation_sims <span class="op">=</span> <span class="fl">20000</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Define parameter bounds</span></span>
<span>  <span class="va">bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    gamma_single_eff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.80</span>, <span class="fl">0.99</span><span class="op">)</span>,</span>
<span>    gamma_single_fut <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.20</span><span class="op">)</span>,</span>
<span>    hr_threshold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.60</span>, <span class="fl">0.90</span><span class="op">)</span>,</span>
<span>    gamma_between_eff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.999</span><span class="op">)</span>,</span>
<span>    gamma_between_fut <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.10</span><span class="op">)</span>,</span>
<span>    pp_go <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.50</span>, <span class="fl">0.90</span><span class="op">)</span>,</span>
<span>    pp_nogo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.10</span>, <span class="fl">0.40</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create objective wrapper for BATON</span></span>
<span>  <span class="va">objective_wrapper</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">phi</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">baton_objective</span><span class="op">(</span></span>
<span>      phi <span class="op">=</span> <span class="va">phi</span>,</span>
<span>      design_template <span class="op">=</span> <span class="va">design_template</span>,</span>
<span>      scenarios <span class="op">=</span> <span class="va">scenarios</span>,</span>
<span>      targets <span class="op">=</span> <span class="va">targets</span>,</span>
<span>      n_sims <span class="op">=</span> <span class="va">baton_config</span><span class="op">$</span><span class="va">n_sims_per_design</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Run BATON optimization</span></span>
<span>  <span class="co"># (Assuming baton_optimize is available from BATON package)</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">baton_optimize</span><span class="op">(</span></span>
<span>    objective <span class="op">=</span> <span class="va">objective_wrapper</span>,</span>
<span>    bounds <span class="op">=</span> <span class="va">bounds</span>,</span>
<span>    n_initial <span class="op">=</span> <span class="va">baton_config</span><span class="op">$</span><span class="va">n_initial</span>,</span>
<span>    n_iterations <span class="op">=</span> <span class="va">baton_config</span><span class="op">$</span><span class="va">n_iterations</span>,</span>
<span>    constrained <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Validate final design</span></span>
<span>  <span class="va">final_design</span> <span class="op">&lt;-</span> <span class="fu">build_design_from_phi</span><span class="op">(</span><span class="va">design_template</span>, <span class="va">result</span><span class="op">$</span><span class="va">best_phi</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">validation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">scenarios</span>, <span class="kw">function</span><span class="op">(</span><span class="va">scen</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sim_results</span> <span class="op">&lt;-</span> <span class="fu">simulate_hybrid_trials</span><span class="op">(</span></span>
<span>      <span class="va">final_design</span>, <span class="va">scen</span>, </span>
<span>      n_sims <span class="op">=</span> <span class="va">baton_config</span><span class="op">$</span><span class="va">n_validation_sims</span>, </span>
<span>      parallel <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">sim_results</span><span class="op">$</span><span class="va">ocs</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Local sensitivity analysis</span></span>
<span>  <span class="va">sensitivity</span> <span class="op">&lt;-</span> <span class="fu">validate_local_neighborhood</span><span class="op">(</span></span>
<span>    <span class="va">result</span><span class="op">$</span><span class="va">best_phi</span>, <span class="va">design_template</span>, <span class="va">scenarios</span>, <span class="va">targets</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    optimal_phi <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">best_phi</span>,</span>
<span>    optimal_design <span class="op">=</span> <span class="va">final_design</span>,</span>
<span>    calibration_trace <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">trace</span>,</span>
<span>    validation <span class="op">=</span> <span class="va">validation</span>,</span>
<span>    sensitivity <span class="op">=</span> <span class="va">sensitivity</span>,</span>
<span>    targets <span class="op">=</span> <span class="va">targets</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_75-local-validation">7.5 Local Validation<a class="anchor" aria-label="anchor" href="#id_75-local-validation"></a></h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Validate Design in Local Neighborhood of Optimal</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param phi Optimal parameter vector</span></span>
<span><span class="co">#' @param design_template Base design</span></span>
<span><span class="co">#' @param scenarios Calibration scenarios</span></span>
<span><span class="co">#' @param targets Target OCs</span></span>
<span><span class="co">#' @param perturbation Relative perturbation (default 5%)</span></span>
<span><span class="co">#' @param n_sims Simulations per perturbed design</span></span>
<span><span class="va">validate_local_neighborhood</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">phi</span>,</span>
<span>  <span class="va">design_template</span>,</span>
<span>  <span class="va">scenarios</span>,</span>
<span>  <span class="va">targets</span>,</span>
<span>  <span class="va">perturbation</span> <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  <span class="va">n_sims</span> <span class="op">=</span> <span class="fl">10000</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">param</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">phi</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Perturb down</span></span>
<span>    <span class="va">phi_low</span> <span class="op">&lt;-</span> <span class="va">phi</span></span>
<span>    <span class="va">phi_low</span><span class="op">[</span><span class="va">param</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span><span class="va">param</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">perturbation</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Perturb up</span></span>
<span>    <span class="va">phi_high</span> <span class="op">&lt;-</span> <span class="va">phi</span></span>
<span>    <span class="va">phi_high</span><span class="op">[</span><span class="va">param</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">phi</span><span class="op">[</span><span class="va">param</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">perturbation</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Evaluate both</span></span>
<span>    <span class="va">oc_low</span> <span class="op">&lt;-</span> <span class="fu">baton_objective</span><span class="op">(</span><span class="va">phi_low</span>, <span class="va">design_template</span>, <span class="va">scenarios</span>, <span class="va">targets</span>, <span class="va">n_sims</span><span class="op">)</span></span>
<span>    <span class="va">oc_high</span> <span class="op">&lt;-</span> <span class="fu">baton_objective</span><span class="op">(</span><span class="va">phi_high</span>, <span class="va">design_template</span>, <span class="va">scenarios</span>, <span class="va">targets</span>, <span class="va">n_sims</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">results</span><span class="op">[[</span><span class="va">param</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      phi_low <span class="op">=</span> <span class="va">phi_low</span><span class="op">[</span><span class="va">param</span><span class="op">]</span>,</span>
<span>      phi_optimal <span class="op">=</span> <span class="va">phi</span><span class="op">[</span><span class="va">param</span><span class="op">]</span>,</span>
<span>      phi_high <span class="op">=</span> <span class="va">phi_high</span><span class="op">[</span><span class="va">param</span><span class="op">]</span>,</span>
<span>      feasible_low <span class="op">=</span> <span class="va">oc_low</span><span class="op">$</span><span class="va">feasible</span>,</span>
<span>      feasible_high <span class="op">=</span> <span class="va">oc_high</span><span class="op">$</span><span class="va">feasible</span>,</span>
<span>      objective_low <span class="op">=</span> <span class="va">oc_low</span><span class="op">$</span><span class="va">value</span>,</span>
<span>      objective_high <span class="op">=</span> <span class="va">oc_high</span><span class="op">$</span><span class="va">value</span>,</span>
<span>      sensitivity <span class="op">=</span> <span class="op">(</span><span class="va">oc_high</span><span class="op">$</span><span class="va">value</span> <span class="op">-</span> <span class="va">oc_low</span><span class="op">$</span><span class="va">value</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">perturbation</span> <span class="op">*</span> <span class="va">phi</span><span class="op">[</span><span class="va">param</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Summary: is the design robust?</span></span>
<span>  <span class="va">all_feasible</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">feasible_low</span> <span class="op">&amp;&amp;</span> <span class="va">x</span><span class="op">$</span><span class="va">feasible_high</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">max_sensitivity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">sensitivity</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    by_parameter <span class="op">=</span> <span class="va">results</span>,</span>
<span>    all_neighbors_feasible <span class="op">=</span> <span class="va">all_feasible</span>,</span>
<span>    max_sensitivity <span class="op">=</span> <span class="va">max_sensitivity</span>,</span>
<span>    robust <span class="op">=</span> <span class="va">all_feasible</span> <span class="op">&amp;&amp;</span> <span class="va">max_sensitivity</span> <span class="op">&lt;</span> <span class="fl">100</span>  <span class="co"># Threshold for "robust"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_8-implementation-phases">8. Implementation Phases<a class="anchor" aria-label="anchor" href="#id_8-implementation-phases"></a></h2>
<div class="section level3">
<h3 id="phase-1-core-infrastructure-week-1-2">Phase 1: Core Infrastructure (Week 1-2)<a class="anchor" aria-label="anchor" href="#phase-1-core-infrastructure-week-1-2"></a></h3>
<p><strong>Objectives</strong>: - Implement posterior computation functions - Implement decision rule functions - Create design and trial S3 classes</p>
<p><strong>Deliverables</strong>:</p>
<pre><code>✓ create_hybrid_surv_design()
✓ initialize_hybrid_trial()
✓ update_posteriors()
✓ compute_decision_quantities()
✓ compute_p_hr_less_than_c()
✓ check_single_arm_efficacy()
✓ check_single_arm_futility()
✓ check_between_arm_efficacy()
✓ check_between_arm_futility()
✓ check_transition_trigger()</code></pre>
<p><strong>Unit tests</strong>: - Verify posterior computations match Monte Carlo for small examples - Verify F-distribution formula for HR comparisons - Verify gamma CDF formula for single-arm comparisons</p>
</div>
<div class="section level3">
<h3 id="phase-2-predictive-probability-engine-week-2-3">Phase 2: Predictive Probability Engine (Week 2-3)<a class="anchor" aria-label="anchor" href="#phase-2-predictive-probability-engine-week-2-3"></a></h3>
<p><strong>Objectives</strong>: - Implement future data simulation - Implement PP computation - Implement sample size finding</p>
<p><strong>Deliverables</strong>:</p>
<pre><code>✓ simulate_future_arm()
✓ compute_pp_between_success()
✓ find_n_for_target_pp()
✓ compute_pp_curve()</code></pre>
<p><strong>Unit tests</strong>: - Verify PP increases with sample size - Verify PP approaches 1 when true effect is large - Verify PP approaches 0 when true effect is null - Benchmark computation time</p>
</div>
<div class="section level3">
<h3 id="phase-3-state-machine-and-simulation-week-3-4">Phase 3: State Machine and Simulation (Week 3-4)<a class="anchor" aria-label="anchor" href="#phase-3-state-machine-and-simulation-week-3-4"></a></h3>
<p><strong>Objectives</strong>: - Implement state transition logic - Implement single trial simulation - Implement multi-trial simulation</p>
<p><strong>Deliverables</strong>:</p>
<pre><code>✓ update_trial_state()
✓ enroll_patients_until_interim()
✓ simulate_hybrid_trial()
✓ simulate_hybrid_trials()
✓ compile_operating_characteristics()</code></pre>
<p><strong>Integration tests</strong>: - Verify state transitions occur correctly - Verify that with extreme thresholds, design reduces to pure single-arm or pure between-arm - Verify parallelization produces consistent results</p>
</div>
<div class="section level3">
<h3 id="phase-4-baton-integration-week-4-5">Phase 4: BATON Integration (Week 4-5)<a class="anchor" aria-label="anchor" href="#phase-4-baton-integration-week-4-5"></a></h3>
<p><strong>Objectives</strong>: - Define calibration scenarios - Implement objective function - Implement calibration wrapper - Implement local validation</p>
<p><strong>Deliverables</strong>:</p>
<pre><code>✓ baton_objective()
✓ build_design_from_phi()
✓ calibrate_hybrid_design()
✓ validate_local_neighborhood()</code></pre>
<p><strong>Validation</strong>: - Run calibration on test problem - Verify type I error control - Verify power targets achieved - Document calibration trace</p>
</div>
<div class="section level3">
<h3 id="phase-5-documentation-and-testing-week-5-6">Phase 5: Documentation and Testing (Week 5-6)<a class="anchor" aria-label="anchor" href="#phase-5-documentation-and-testing-week-5-6"></a></h3>
<p><strong>Objectives</strong>: - Write vignette - Complete unit test coverage - Performance optimization</p>
<p><strong>Deliverables</strong>:</p>
<pre><code>✓ Vignette: hybrid_design_workflow.Rmd
✓ Full test coverage (&gt;90%)
✓ Performance benchmarks
✓ Documentation for all exported functions</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="id_9-testing-strategy">9. Testing Strategy<a class="anchor" aria-label="anchor" href="#id_9-testing-strategy"></a></h2>
<div class="section level3">
<h3 id="id_91-unit-tests">9.1 Unit Tests<a class="anchor" aria-label="anchor" href="#id_91-unit-tests"></a></h3>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># tests/test_hybrid_posterior.R</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Gamma CDF formula for single-arm is correct"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Compare closed form to Monte Carlo</span></span>
<span>  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span>  <span class="va">threshold</span> <span class="op">&lt;-</span> <span class="fl">1.5</span></span>
<span>  </span>
<span>  <span class="co"># Closed form</span></span>
<span>  <span class="va">p_closed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">pgamma</a></span><span class="op">(</span><span class="va">threshold</span>, shape <span class="op">=</span> <span class="va">a</span>, rate <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Monte Carlo</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  <span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fl">100000</span>, shape <span class="op">=</span> <span class="va">a</span>, rate <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span>  <span class="va">p_mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">samples</span> <span class="op">&lt;</span> <span class="va">threshold</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">p_closed</span>, <span class="va">p_mc</span>, tolerance <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"F distribution formula for between-arm HR is correct"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Compare closed form to Monte Carlo</span></span>
<span>  <span class="va">a_A</span> <span class="op">&lt;-</span> <span class="fl">15</span></span>
<span>  <span class="va">b_A</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span>  <span class="va">a_B</span> <span class="op">&lt;-</span> <span class="fl">12</span></span>
<span>  <span class="va">b_B</span> <span class="op">&lt;-</span> <span class="fl">6</span></span>
<span>  </span>
<span>  <span class="co"># Closed form</span></span>
<span>  <span class="va">p_closed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html" class="external-link">pf</a></span><span class="op">(</span></span>
<span>    q <span class="op">=</span> <span class="op">(</span><span class="va">b_A</span> <span class="op">/</span> <span class="va">b_B</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">a_B</span> <span class="op">/</span> <span class="va">a_A</span><span class="op">)</span>,</span>
<span>    df1 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_A</span>,</span>
<span>    df2 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_B</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Monte Carlo</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span>  <span class="va">lambda_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fl">100000</span>, shape <span class="op">=</span> <span class="va">a_A</span>, rate <span class="op">=</span> <span class="va">b_A</span><span class="op">)</span></span>
<span>  <span class="va">lambda_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fl">100000</span>, shape <span class="op">=</span> <span class="va">a_B</span>, rate <span class="op">=</span> <span class="va">b_B</span><span class="op">)</span></span>
<span>  <span class="va">p_mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lambda_A</span> <span class="op">/</span> <span class="va">lambda_B</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">p_closed</span>, <span class="va">p_mc</span>, tolerance <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Posterior update accumulates sufficient statistics correctly"</span>, <span class="op">{</span></span>
<span>  <span class="va">design</span> <span class="op">&lt;-</span> <span class="fu">create_hybrid_surv_design</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu">initialize_hybrid_trial</span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Add some patients manually</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">patients</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>    arm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    enrollment_time <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    event_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">8</span>, <span class="fl">10</span>, <span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">9</span><span class="op">)</span>,</span>
<span>    observed_time <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    event <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="va">current_time</span> <span class="op">&lt;-</span> <span class="fl">12</span></span>
<span>  </span>
<span>  <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/update_posteriors.html">update_posteriors</a></span><span class="op">(</span><span class="va">trial</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Check sufficient statistics</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span>, <span class="va">design</span><span class="op">$</span><span class="va">prior</span><span class="op">$</span><span class="va">a0</span> <span class="op">+</span> <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">posterior</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="st">"B"</span><span class="op">]</span>, <span class="va">design</span><span class="op">$</span><span class="va">prior</span><span class="op">$</span><span class="va">a0</span> <span class="op">+</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_92-integration-tests">9.2 Integration Tests<a class="anchor" aria-label="anchor" href="#id_92-integration-tests"></a></h3>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># tests/test_hybrid_simulate.R</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Design reduces to single-arm when between-arm threshold is impossible"</span>, <span class="op">{</span></span>
<span>  <span class="va">design</span> <span class="op">&lt;-</span> <span class="fu">create_hybrid_surv_design</span><span class="op">(</span></span>
<span>    between_arm_criteria <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>eff_prob <span class="op">=</span> <span class="fl">1.0</span>, fut_prob <span class="op">=</span> <span class="fl">0.0</span><span class="op">)</span>  <span class="co"># Never achievable</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>true_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.04</span>, B <span class="op">=</span> <span class="fl">0.06</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">simulate_hybrid_trials</span><span class="op">(</span><span class="va">design</span>, <span class="va">scenario</span>, n_sims <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Should never reach between-arm efficacy</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">ocs</span><span class="op">$</span><span class="va">prob_between_efficacy_overall</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Type I error is controlled under null scenario"</span>, <span class="op">{</span></span>
<span>  <span class="fu">skip_on_cran</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Long-running test</span></span>
<span>  </span>
<span>  <span class="va">design</span> <span class="op">&lt;-</span> <span class="fu">create_hybrid_surv_design</span><span class="op">(</span><span class="op">)</span>  <span class="co"># Default calibrated design</span></span>
<span>  </span>
<span>  <span class="va">null_scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>true_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.0578</span>, B <span class="op">=</span> <span class="fl">0.0578</span><span class="op">)</span><span class="op">)</span>  <span class="co"># HR = 1</span></span>
<span>  </span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">simulate_hybrid_trials</span><span class="op">(</span><span class="va">design</span>, <span class="va">null_scenario</span>, n_sims <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Between-arm type I error should be &lt; 0.05 (or whatever target)</span></span>
<span>  <span class="fu">expect_lt</span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">ocs</span><span class="op">$</span><span class="va">prob_between_efficacy_overall</span>, <span class="fl">0.06</span><span class="op">)</span>  <span class="co"># Allow small margin</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="id_93-edge-case-tests">9.3 Edge Case Tests<a class="anchor" aria-label="anchor" href="#id_93-edge-case-tests"></a></h3>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># tests/test_hybrid_edge_cases.R</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Trial handles all arms dropped for futility"</span>, <span class="op">{</span></span>
<span>  <span class="va">design</span> <span class="op">&lt;-</span> <span class="fu">create_hybrid_surv_design</span><span class="op">(</span></span>
<span>    single_arm_criteria <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hr_threshold <span class="op">=</span> <span class="fl">0.5</span>, eff_prob <span class="op">=</span> <span class="fl">0.9</span>, fut_prob <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Scenario where both arms are worse than historical</span></span>
<span>  <span class="va">bad_scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>true_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.08</span>, B <span class="op">=</span> <span class="fl">0.08</span><span class="op">)</span><span class="op">)</span>  <span class="co"># Worse than 0.0578</span></span>
<span>  </span>
<span>  <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu">simulate_hybrid_trial</span><span class="op">(</span><span class="va">design</span>, <span class="va">bad_scenario</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">state</span>, <span class="st">"STATE_STOP"</span><span class="op">)</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">conclusion</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"all_arms_futile"</span>, <span class="st">"max_n_single_phase"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Trial handles conversion at first interim"</span>, <span class="op">{</span></span>
<span>  <span class="va">design</span> <span class="op">&lt;-</span> <span class="fu">create_hybrid_surv_design</span><span class="op">(</span></span>
<span>    single_arm_criteria <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hr_threshold <span class="op">=</span> <span class="fl">0.95</span>, eff_prob <span class="op">=</span> <span class="fl">0.5</span>, fut_prob <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Scenario with strong effect</span></span>
<span>  <span class="va">strong_scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>true_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fl">0.03</span>, B <span class="op">=</span> <span class="fl">0.04</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu">simulate_hybrid_trial</span><span class="op">(</span><span class="va">design</span>, <span class="va">strong_scenario</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Should trigger conversion early</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="va">trial</span><span class="op">$</span><span class="va">conversion_triggered</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="appendix-a-mathematical-derivations">Appendix A: Mathematical Derivations<a class="anchor" aria-label="anchor" href="#appendix-a-mathematical-derivations"></a></h2>
<div class="section level3">
<h3 id="a1-derivation-of-phr--c-using-f-distribution">A.1 Derivation of P(HR &lt; c) Using F Distribution<a class="anchor" aria-label="anchor" href="#a1-derivation-of-phr--c-using-f-distribution"></a></h3>
<p>Let <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>A</mi></msub><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>A</mi></msub><mo>,</mo><msub><mi>b</mi><mi>A</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_A \sim \text{Gamma}(a_A, b_A)</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>B</mi></msub><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>B</mi></msub><mo>,</mo><msub><mi>b</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_B \sim \text{Gamma}(a_B, b_B)</annotation></semantics></math> be independent.</p>
<p>We want <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>λ</mi><mi>A</mi></msub><mi>/</mi><msub><mi>λ</mi><mi>B</mi></msub><mo>&lt;</mo><mi>c</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(\lambda_A / \lambda_B &lt; c)</annotation></semantics></math>.</p>
<p><strong>Step 1</strong>: Standardize by rates.</p>
<p>Let <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>=</mo><msub><mi>λ</mi><mi>A</mi></msub><mi>/</mi><msub><mi>b</mi><mi>A</mi></msub><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>A</mi></msub><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">X = \lambda_A / b_A \sim \text{Gamma}(a_A, 1)</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><msub><mi>λ</mi><mi>B</mi></msub><mi>/</mi><msub><mi>b</mi><mi>B</mi></msub><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>B</mi></msub><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y = \lambda_B / b_B \sim \text{Gamma}(a_B, 1)</annotation></semantics></math>.</p>
<p>Then <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>A</mi></msub><mi>/</mi><msub><mi>λ</mi><mi>B</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>b</mi><mi>A</mi></msub><mi>/</mi><msub><mi>b</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>X</mi><mi>/</mi><mi>Y</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_A / \lambda_B = (b_A / b_B) \cdot (X / Y)</annotation></semantics></math>.</p>
<p><strong>Step 2</strong>: Use the Gamma-to-F relationship.</p>
<p>If <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">X \sim \text{Gamma}(a, 1)</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>b</mi><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y \sim \text{Gamma}(b, 1)</annotation></semantics></math> are independent, then:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>X</mi><mi>/</mi><mi>a</mi></mrow><mrow><mi>Y</mi><mi>/</mi><mi>b</mi></mrow></mfrac><mo>∼</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>a</mi><mo>,</mo><mn>2</mn><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{X/a}{Y/b} \sim F(2a, 2b)</annotation></semantics></math></p>
<p>So <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mi>/</mi><mi>Y</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mi>/</mi><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>⋅</mo><mi>F</mi></mrow><annotation encoding="application/x-tex">X/Y = (a/b) \cdot F</annotation></semantics></math> where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>∼</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>a</mi><mo>,</mo><mn>2</mn><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">F \sim F(2a, 2b)</annotation></semantics></math>.</p>
<p><strong>Step 3</strong>: Combine.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mi>λ</mi><mi>A</mi></msub><msub><mi>λ</mi><mi>B</mi></msub></mfrac><mo>=</mo><mfrac><msub><mi>b</mi><mi>A</mi></msub><msub><mi>b</mi><mi>B</mi></msub></mfrac><mo>⋅</mo><mfrac><mi>X</mi><mi>Y</mi></mfrac><mo>=</mo><mfrac><msub><mi>b</mi><mi>A</mi></msub><msub><mi>b</mi><mi>B</mi></msub></mfrac><mo>⋅</mo><mfrac><msub><mi>a</mi><mi>A</mi></msub><msub><mi>a</mi><mi>B</mi></msub></mfrac><mo>⋅</mo><mi>F</mi></mrow><annotation encoding="application/x-tex">\frac{\lambda_A}{\lambda_B} = \frac{b_A}{b_B} \cdot \frac{X}{Y} = \frac{b_A}{b_B} \cdot \frac{a_A}{a_B} \cdot F</annotation></semantics></math></p>
<p>where <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>∼</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><msub><mi>a</mi><mi>A</mi></msub><mo>,</mo><mn>2</mn><msub><mi>a</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">F \sim F(2a_A, 2a_B)</annotation></semantics></math>.</p>
<p><strong>Step 4</strong>: Compute probability.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>λ</mi><mi>A</mi></msub><msub><mi>λ</mi><mi>B</mi></msub></mfrac><mo>&lt;</mo><mi>c</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>F</mi><mo>&lt;</mo><mi>c</mi><mo>⋅</mo><mfrac><msub><mi>b</mi><mi>B</mi></msub><msub><mi>b</mi><mi>A</mi></msub></mfrac><mo>⋅</mo><mfrac><msub><mi>a</mi><mi>B</mi></msub><msub><mi>a</mi><mi>A</mi></msub></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>F</mi><mi>F</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>c</mi><mo>⋅</mo><mfrac><mrow><msub><mi>b</mi><mi>B</mi></msub><mo>⋅</mo><msub><mi>a</mi><mi>B</mi></msub></mrow><mrow><msub><mi>b</mi><mi>A</mi></msub><mo>⋅</mo><msub><mi>a</mi><mi>A</mi></msub></mrow></mfrac><mo>;</mo><mn>2</mn><msub><mi>a</mi><mi>A</mi></msub><mo>,</mo><mn>2</mn><msub><mi>a</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P\left(\frac{\lambda_A}{\lambda_B} &lt; c\right) = P\left(F &lt; c \cdot \frac{b_B}{b_A} \cdot \frac{a_B}{a_A}\right) = F_F\left(c \cdot \frac{b_B \cdot a_B}{b_A \cdot a_A}; 2a_A, 2a_B\right)</annotation></semantics></math></p>
<p>Wait, let me recheck this. We have:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mi>λ</mi><mi>A</mi></msub><msub><mi>λ</mi><mi>B</mi></msub></mfrac><mo>&lt;</mo><mi>c</mi><mo>⇔</mo><mfrac><msub><mi>b</mi><mi>A</mi></msub><msub><mi>b</mi><mi>B</mi></msub></mfrac><mo>⋅</mo><mfrac><msub><mi>a</mi><mi>A</mi></msub><msub><mi>a</mi><mi>B</mi></msub></mfrac><mo>⋅</mo><mi>F</mi><mo>&lt;</mo><mi>c</mi><mo>⇔</mo><mi>F</mi><mo>&lt;</mo><mi>c</mi><mo>⋅</mo><mfrac><msub><mi>b</mi><mi>B</mi></msub><msub><mi>b</mi><mi>A</mi></msub></mfrac><mo>⋅</mo><mfrac><msub><mi>a</mi><mi>B</mi></msub><msub><mi>a</mi><mi>A</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\frac{\lambda_A}{\lambda_B} &lt; c \iff \frac{b_A}{b_B} \cdot \frac{a_A}{a_B} \cdot F &lt; c \iff F &lt; c \cdot \frac{b_B}{b_A} \cdot \frac{a_B}{a_A}</annotation></semantics></math></p>
<p>Hmm, that’s different from what I wrote earlier. Let me recalculate.</p>
<p>Actually, the correct relationship is:</p>
<p>If <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>a</mi><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">X \sim \text{Gamma}(a, 1)</annotation></semantics></math>, then <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>X</mi><mo>∼</mo><msup><mi>χ</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mi>a</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">2X \sim \chi^2(2a)</annotation></semantics></math>.</p>
<p>So if <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>A</mi></msub><mo>∼</mo><mtext mathvariant="normal">Gamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>a</mi><mi>A</mi></msub><mo>,</mo><msub><mi>b</mi><mi>A</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\lambda_A \sim \text{Gamma}(a_A, b_A)</annotation></semantics></math>, then <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><msub><mi>b</mi><mi>A</mi></msub><msub><mi>λ</mi><mi>A</mi></msub><mo>∼</mo><msup><mi>χ</mi><mn>2</mn></msup><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><msub><mi>a</mi><mi>A</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">2 b_A \lambda_A \sim \chi^2(2a_A)</annotation></semantics></math>.</p>
<p>The ratio: <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><msub><mi>λ</mi><mi>A</mi></msub><mi>/</mi><msub><mi>a</mi><mi>A</mi></msub></mrow><mrow><msub><mi>λ</mi><mi>B</mi></msub><mi>/</mi><msub><mi>a</mi><mi>B</mi></msub></mrow></mfrac><mo>⋅</mo><mfrac><msub><mi>b</mi><mi>A</mi></msub><msub><mi>b</mi><mi>B</mi></msub></mfrac><mo>=</mo><mfrac><mrow><mn>2</mn><msub><mi>b</mi><mi>A</mi></msub><msub><mi>λ</mi><mi>A</mi></msub><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><msub><mi>a</mi><mi>A</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mn>2</mn><msub><mi>b</mi><mi>B</mi></msub><msub><mi>λ</mi><mi>B</mi></msub><mi>/</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><msub><mi>a</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>∼</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><msub><mi>a</mi><mi>A</mi></msub><mo>,</mo><mn>2</mn><msub><mi>a</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\frac{\lambda_A / a_A}{\lambda_B / a_B} \cdot \frac{b_A}{b_B} = \frac{2 b_A \lambda_A / (2 a_A)}{2 b_B \lambda_B / (2 a_B)} \sim F(2a_A, 2a_B)</annotation></semantics></math></p>
<p>Therefore: <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mi>λ</mi><mi>A</mi></msub><msub><mi>λ</mi><mi>B</mi></msub></mfrac><mo>=</mo><mfrac><msub><mi>a</mi><mi>A</mi></msub><msub><mi>a</mi><mi>B</mi></msub></mfrac><mo>⋅</mo><mfrac><msub><mi>b</mi><mi>B</mi></msub><msub><mi>b</mi><mi>A</mi></msub></mfrac><mo>⋅</mo><mi>F</mi></mrow><annotation encoding="application/x-tex">\frac{\lambda_A}{\lambda_B} = \frac{a_A}{a_B} \cdot \frac{b_B}{b_A} \cdot F</annotation></semantics></math></p>
<p>And: <math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>λ</mi><mi>A</mi></msub><msub><mi>λ</mi><mi>B</mi></msub></mfrac><mo>&lt;</mo><mi>c</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>F</mi><mo>&lt;</mo><mi>c</mi><mo>⋅</mo><mfrac><msub><mi>a</mi><mi>B</mi></msub><msub><mi>a</mi><mi>A</mi></msub></mfrac><mo>⋅</mo><mfrac><msub><mi>b</mi><mi>A</mi></msub><msub><mi>b</mi><mi>B</mi></msub></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P\left(\frac{\lambda_A}{\lambda_B} &lt; c\right) = P\left(F &lt; c \cdot \frac{a_B}{a_A} \cdot \frac{b_A}{b_B}\right)</annotation></semantics></math></p>
<p>So the correct formula is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mtext mathvariant="normal">HR</mtext><mrow><mi>A</mi><mi>B</mi></mrow></msub><mo>&lt;</mo><mi>c</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>F</mi><mi>F</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>c</mi><mo>⋅</mo><mfrac><mrow><msub><mi>a</mi><mi>B</mi></msub><mo>⋅</mo><msub><mi>b</mi><mi>A</mi></msub></mrow><mrow><msub><mi>a</mi><mi>A</mi></msub><mo>⋅</mo><msub><mi>b</mi><mi>B</mi></msub></mrow></mfrac><mo>;</mo><mn>2</mn><msub><mi>a</mi><mi>A</mi></msub><mo>,</mo><mn>2</mn><msub><mi>a</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(\text{HR}_{AB} &lt; c) = F_F\left(c \cdot \frac{a_B \cdot b_A}{a_A \cdot b_B}; 2a_A, 2a_B\right)</annotation></semantics></math></p>
<p>For <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">c = 1</annotation></semantics></math>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mtext mathvariant="normal">HR</mtext><mrow><mi>A</mi><mi>B</mi></mrow></msub><mo>&lt;</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>F</mi><mi>F</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><msub><mi>a</mi><mi>B</mi></msub><mo>⋅</mo><msub><mi>b</mi><mi>A</mi></msub></mrow><mrow><msub><mi>a</mi><mi>A</mi></msub><mo>⋅</mo><msub><mi>b</mi><mi>B</mi></msub></mrow></mfrac><mo>;</mo><mn>2</mn><msub><mi>a</mi><mi>A</mi></msub><mo>,</mo><mn>2</mn><msub><mi>a</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(\text{HR}_{AB} &lt; 1) = F_F\left(\frac{a_B \cdot b_A}{a_A \cdot b_B}; 2a_A, 2a_B\right)</annotation></semantics></math></p>
<p><strong>Verification in R</strong>:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Verify with Monte Carlo</span></span>
<span><span class="va">a_A</span> <span class="op">&lt;-</span> <span class="fl">15</span>; <span class="va">b_A</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="va">a_B</span> <span class="op">&lt;-</span> <span class="fl">12</span>; <span class="va">b_B</span> <span class="op">&lt;-</span> <span class="fl">6</span></span>
<span></span>
<span><span class="co"># Closed form</span></span>
<span><span class="va">p_closed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html" class="external-link">pf</a></span><span class="op">(</span></span>
<span>  q <span class="op">=</span> <span class="op">(</span><span class="va">a_B</span> <span class="op">*</span> <span class="va">b_A</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">a_A</span> <span class="op">*</span> <span class="va">b_B</span><span class="op">)</span>,</span>
<span>  df1 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_A</span>,</span>
<span>  df2 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_B</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Monte Carlo</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">lambda_A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fl">1e6</span>, shape <span class="op">=</span> <span class="va">a_A</span>, rate <span class="op">=</span> <span class="va">b_A</span><span class="op">)</span></span>
<span><span class="va">lambda_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fl">1e6</span>, shape <span class="op">=</span> <span class="va">a_B</span>, rate <span class="op">=</span> <span class="va">b_B</span><span class="op">)</span></span>
<span><span class="va">p_mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lambda_A</span> <span class="op">/</span> <span class="va">lambda_B</span> <span class="op">&lt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>closed <span class="op">=</span> <span class="va">p_closed</span>, mc <span class="op">=</span> <span class="va">p_mc</span><span class="op">)</span></span>
<span><span class="co"># Should be approximately equal</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="a2-corrected-implementation">A.2 Corrected Implementation<a class="anchor" aria-label="anchor" href="#a2-corrected-implementation"></a></h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Compute P(lambda_j / lambda_l &lt; c) for independent Gamma posteriors</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @param a_j Shape parameter for numerator (arm j)</span></span>
<span><span class="co">#' @param b_j Rate parameter for numerator (arm j)</span></span>
<span><span class="co">#' @param a_l Shape parameter for denominator (arm l)</span></span>
<span><span class="co">#' @param b_l Rate parameter for denominator (arm l)</span></span>
<span><span class="co">#' @param c Threshold for hazard ratio (default 1)</span></span>
<span><span class="co">#' @return Probability P(HR &lt; c)</span></span>
<span><span class="va">compute_p_hr_less_than_c</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a_j</span>, <span class="va">b_j</span>, <span class="va">a_l</span>, <span class="va">b_l</span>, <span class="va">c</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Fdist.html" class="external-link">pf</a></span><span class="op">(</span></span>
<span>    q <span class="op">=</span> <span class="va">c</span> <span class="op">*</span> <span class="op">(</span><span class="va">a_l</span> <span class="op">*</span> <span class="va">b_j</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">a_j</span> <span class="op">*</span> <span class="va">b_l</span><span class="op">)</span>,</span>
<span>    df1 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_j</span>,</span>
<span>    df2 <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">a_l</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="appendix-b-glossary">Appendix B: Glossary<a class="anchor" aria-label="anchor" href="#appendix-b-glossary"></a></h2>
<table class="table"><colgroup><col width="33%"><col width="66%"></colgroup><thead><tr class="header"><th>Term</th>
<th>Definition</th>
</tr></thead><tbody><tr class="odd"><td><strong>HR</strong></td>
<td>Hazard ratio</td>
</tr><tr class="even"><td><strong>PP</strong></td>
<td>Predictive probability</td>
</tr><tr class="odd"><td><strong>BATON</strong></td>
<td>Bayesian Adaptive Trial Optimization Navigator</td>
</tr><tr class="even"><td><strong>OC</strong></td>
<td>Operating characteristic</td>
</tr><tr class="odd"><td><strong>RAR</strong></td>
<td>Response-adaptive randomization</td>
</tr><tr class="even"><td><strong>Sufficient statistics</strong></td>
<td>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>n</mi><mi>k</mi></msub><mo>,</mo><msub><mi>T</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(n_k, T_k)</annotation></semantics></math> = (number of events, total exposure) for arm <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math></td>
</tr><tr class="odd"><td><strong>Conjugate prior</strong></td>
<td>Gamma prior for exponential likelihood</td>
</tr><tr class="even"><td><strong>Gatekeeping</strong></td>
<td>Sequential testing where one hypothesis gates another</td>
</tr></tbody></table><hr><p><em>End of specification document.</em></p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Naim Rashid.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

